import*as Foundation from"./lib.foundation.js";import*as decomp from"./extlib/poly-decomp-0.2.1.min.js";import{MatterJS}from"./extlib/matter-0.20.0.min.js";import IntersectsJS from"./extlib/intersects-2.7.1.min.js";class Point{constructor(x,y,attributes={}){const{blocked={x:false,y:false},scale=1}=attributes;this._x=x*scale;this._y=y*scale;this._blocked=blocked;this._scale=scale}fromString(point){const match=point.match(/([0-9]+),\s*([0-9]+)/);return new Point(parseInt(match[1]),parseInt(match[2]))}toRealPosition(element){const rect=element.getBoundingClientRect();this._x-=rect.left;this._y-=rect.top;this._x/=this._scale/this._scale;this._y/=this._scale/this._scale;return this}isInTriangle(points){const as_x=this._x-points[0].x;const as_y=this._y-points[0].y;const s_ab=(points[1].x-points[0].x)*as_y-(points[1].y-points[0].y)*as_x>0;if((points[2].x-points[0].x)*as_y-(points[2].y-points[0].y)*as_x>0==s_ab)return false;if((points[2].x-points[1].x)*(this._y-points[1].y)-(points[2].y-points[1].y)*(this._x-points[1].x)>0!=s_ab)return false;return true}isInPolygon(points){let inside=false;let point1=new Point(0,0);let point2=new Point(0,0);if(points.length<3)return inside;let oldPoint=new Point(points[points.length-1].x,points[points.length-1].y);for(let i=0;i<points.length;i++){let v2NewPoint=new Point(points[i].x,points[i].y);if(v2NewPoint.x>oldPoint.x){point1=oldPoint;point2=v2NewPoint}else{point1=v2NewPoint;point2=oldPoint}if(v2NewPoint.x<this._x==this._x<=oldPoint.x&&(this._y-point1.y)*(point2.x-point1.x)<(point2.y-point1.y)*(this._x-point1.x))inside=!inside;oldPoint=v2NewPoint}return inside}isInQuad(topleft,bottomright){if(this.x>=topleft.x&&this.x<=bottomright.x&&this.y>=topleft.y&&this.y<=bottomright.y)return true;else return false}isInCircle(point,radius){if((point.x-this._x)*(point.x-this._x)+(point.y-this._y)*(point.y-this._y)<=radius*radius)return true;else return false}translate(angle,distance){const radian=(angle+90)*Math.PI/180;this._x+=distance*Math.sin(radian);this._y-=distance*Math.cos(radian);return this}static distance(point1,point2){return Math.sqrt((point1.x-point2.x)*(point1.x-point2.x)+(point1.y-point2.y)*(point1.y-point2.y))}static middle(point1,point2){return new Point((point1.x+point2.x)/2,(point1.y+point2.y)/2)}static angle(point1,point2){const delta=Point.delta(point1,point2);let theta=Math.atan2(delta.y,delta.x);theta*=180/Math.PI;return theta}static delta(point1,point2){return new Point(point2.x-point1.x||0,point2.y-point1.y||0)}get x(){return this._x}set x(x){if(!this._blocked.x)this._x=x}get y(){return this._y}set y(y){if(!this._blocked.y)this._y=y}get scale(){return this._scale}set scale(scale){this._scale=scale}get blocked(){return this._blocked}set blocked(blocked){this._blocked=blocked}}class Size{constructor(width,height,attributes={}){this._width=width;this._height=height;const{blocked={width:false,height:false}}=attributes;this._blocked=blocked}fromString(size){const match=size.match(/([0-9]+),\s*([0-9]+)/);return new Size(parseInt(match[1]),parseInt(match[2]))}get width(){return this._width}set width(width){if(!this._blocked.width)this._width=width}get height(){return this._height}set height(height){if(!this._blocked.height)this._height=height}get blocked(){return this._blocked}set blocked(blocked){this._blocked=blocked}}class Matrix{constructor(matrix=[1,0,0,1,0,0]){this._matrix=new DOMMatrix(matrix)}translate(translate){this.x+=translate.x?translate.x:0;this.y+=translate.y?translate.y:0;return this}rotate(rotate){const scale=this.scale;const rad=rotate.rad?rotate.rad:Math.PI/180*rotate.angle;const sin=Math.sin(rad);const cos=Math.cos(rad);this.multiply(new Matrix([cos*scale.x,sin*scale.x,-sin*scale.y,cos*scale.y,0,0]));return this}reflect(reflect){const scale=this.scale;const rad=Math.PI/180*reflect.angle;const sin=Math.sin(2*rad);const cos=Math.cos(2*rad);this.multiply(new Matrix([cos*scale.x,sin*scale.x,sin*scale.y,-cos*scale.y,0,0]));return this}stretch(stretch){this.multiply(new Matrix([stretch.x?stretch.x:1,0,0,stretch.y?stretch.y:1,0,0]));return this}shear(shear){this.multiply(new Matrix([1,shear.y?Math.PI/180*shear.y:0,shear.x?Math.PI/180*shear.x:0,1,0,0]));return this}multiply(other){const current=new Matrix(this.array);this._matrix.a=current.matrix.a*other.matrix.a+current.matrix.c*other.matrix.b;this._matrix.b=current.matrix.b*other.matrix.a+current.matrix.d*other.matrix.b;this._matrix.c=current.matrix.a*other.matrix.c+current.matrix.c*other.matrix.d;this._matrix.d=current.matrix.b*other.matrix.c+current.matrix.d*other.matrix.d;return this}add(other){this._matrix.a+=other.matrix.a;this._matrix.b+=other.matrix.b;this._matrix.c+=other.matrix.c;this._matrix.d+=other.matrix.d;this._matrix.e+=other.matrix.e;this._matrix.f+=other.matrix.f;return this}subtract(other){this._matrix.a-=other.matrix.a;this._matrix.b-=other.matrix.b;this._matrix.c-=other.matrix.c;this._matrix.d-=other.matrix.d;this._matrix.e-=other.matrix.e;this._matrix.f-=other.matrix.f;return this}get array(){return[this._matrix.a,this._matrix.b,this._matrix.c,this._matrix.d,this._matrix.e,this._matrix.f]}get matrix(){return this._matrix}set matrix(matrix){this._matrix=matrix}get x(){return this._matrix.e}set x(x){this._matrix.e=Math.round(x)}get y(){return this._matrix.f}set y(y){this._matrix.f=Math.round(y)}get rad(){return Math.atan2(this._matrix.b,this._matrix.a)}set rad(rad){const scale=this.scale;const sin=Math.sin(rad);const cos=Math.cos(rad);this._matrix.a=cos*scale.x;this._matrix.b=sin*scale.x;this._matrix.c=-sin*scale.y;this._matrix.d=cos*scale.y}get angle(){const rad=this.rad;let angle=Math.round(rad*(180/Math.PI));if(rad<0)angle+=360;return angle}set angle(angle){const scale=this.scale;const rad=Math.PI/180*angle;const sin=Math.sin(rad);const cos=Math.cos(rad);this._matrix.a=cos*scale.x;this._matrix.b=sin*scale.x;this._matrix.c=-sin*scale.y;this._matrix.d=cos*scale.y}get scale(){const det=this._matrix.a*this._matrix.a+this._matrix.b*this._matrix.b;const scalex=Math.sqrt(det);const scaley=(this._matrix.a*this._matrix.d-this._matrix.c*this._matrix.b)/scalex;return{x:scalex,y:scaley}}set scale(scale){const rad=this.rad;const sin=Math.sin(rad);const cos=Math.cos(rad);if(scale.x){this._matrix.a=cos*scale.x;this._matrix.b=sin*scale.x}if(scale.y){this._matrix.c=-sin*scale.y;this._matrix.d=cos*scale.y}}}class Layer{constructor(attributes={}){this._guid=undefined;this._context=undefined;this._fx=undefined;this._populated=false;this._canvas=new OffscreenCanvas(0,0);this._context2D=this._canvas.getContext("2d",{alpha:true});this._drawables=new Foundation.ExtendedMap;this._controls=new Foundation.ExtendedMap;this._components=new Foundation.ExtendedMap;this._groups=new Foundation.ExtendedMap;this._drawactions=new Foundation.ExtendedMap;this._mouseactions=new Foundation.ExtendedMap;this._dragactions=new Foundation.ExtendedMap;const{context=null,index=0,freezed=false,visible=true,onAttach=null,onDetach=null}=attributes;this._index=index;this._freezed=freezed;this._visible=visible;context?context.attach(this):null;onAttach?this.onAttach=onAttach:null;onDetach?this.onDetach=onDetach:null}static encode(layer){return String(layer).padStart(4,"0")}static decode(guid){return Number(guid.substring(9,13))}freeze(){this._freezed=true;this._canvas.width=this.context.canvas.width;this._canvas.height=this.context.canvas.height}unfreeze(){this._freezed=false;this._bitmap=undefined}save(){this._bitmap=this._canvas.transferToImageBitmap()}onAttach(self){}onDetach(self){this._drawables.forEach((drawable=>{this.context.detach(drawable.guid)}));this._controls.forEach((control=>{this.context.detach(control.guid)}));this._components.forEach((component=>{this.context.detach(component.guid)}));this._groups.forEach((group=>{this.context.detach(group.guid)}));this._drawactions.forEach((drawaction=>{this.context.detach(drawaction.guid)}));this._mouseactions.forEach((mouseaction=>{this.context.detach(mouseaction.guid)}));this._dragactions.forEach((dragaction=>{this.context.detach(dragaction.guid)}))}get context(){return this._context}set context(context){this._context=context}get fx(){return this._fx}set fx(fx){this._fx=fx}get guid(){return this._guid}set guid(guid){this._guid=guid}get index(){return this._index}get canvas(){return this._canvas}get context2D(){return this._context2D}get freezed(){return this._freezed}get bitmap(){return this._bitmap}get visible(){return this._visible}set visible(visible){this._visible=visible}get drawables(){return this._drawables}get controls(){return this._controls}get groups(){return this._groups}get components(){return this._components}get drawactions(){return this._drawactions}get mouseactions(){return this._mouseactions}get dragactions(){return this._dragactions}}var Restrict;(function(Restrict){Restrict[Restrict["none"]=0]="none";Restrict[Restrict["horizontal"]=1]="horizontal";Restrict[Restrict["vertical"]=2]="vertical";Restrict[Restrict["ondrag"]=3]="ondrag";Restrict[Restrict["onrelease"]=4]="onrelease";Restrict[Restrict["norefresh"]=5]="norefresh"})(Restrict||(Restrict={}));class Drawable extends Matrix{constructor(attributes={}){super();this._context=undefined;this._fx=undefined;this._guid=undefined;this._group=undefined;this._hover=false;this._points=[];const{nofill=false,nostroke=false,shadow=0,shadowcolor="#ffffff",fillcolor="#a0a0a0",strokecolor="#a0a0a0",linewidth=1,alpha=1,angle=0,visible=true,sticky=false,removable=true,hoverable=true,point={x:window.innerWidth/2,y:window.innerHeight/2},points=[],scale={x:1,y:1},offset1={x:0,y:0},offset2={x:0,y:0},size={width:50,height:50},matrix=null,context=null,layer=null,path=new Path2D,onAttach=null,onDetach=null,onResize=null}=attributes;this._nofill=nofill;this._nostroke=nostroke;this._shadow=shadow;this._shadowcolor=shadowcolor;this._fillcolor=fillcolor;this._strokecolor=strokecolor;this._linewidth=linewidth;this._alpha=alpha;this._angle=angle;this._visible=visible;this._sticky=sticky;this._removable=removable;this._hoverable=hoverable;this._offset1=offset1;this._offset2=offset2;this._size=size;this._path=path;this._points=points;context?context.attach(this,layer):null;onAttach?this.onAttach=onAttach:null;onDetach?this.onDetach=onDetach:null;onResize?this.onResize=onResize:null;if(matrix)this.matrix=matrix;else{const rad=Math.PI/180*angle;const sin=Math.sin(rad);const cos=Math.cos(rad);this.matrix=new DOMMatrix([cos*scale.x,sin*scale.x,-sin*scale.y,cos*scale.y,point.x,point.y])}}generate(){}draw(context2D){context2D.save();context2D.setTransform(this.matrix.a,this.matrix.b,this.matrix.c,this.matrix.d,this.matrix.e+this.offset1.x+this.offset2.x,this.matrix.f+this.offset1.y+this.offset2.y);context2D.globalAlpha=this.alpha;context2D.imageSmoothingEnabled=false;context2D.strokeStyle=this.strokecolor;context2D.lineWidth=this.linewidth;if(!this._nostroke)context2D.stroke(this.path);context2D.shadowBlur=this.shadow;context2D.shadowColor=this.shadowcolor;context2D.fillStyle=this.fillcolor;if(!this._nofill)context2D.fill(this.path);context2D.restore()}isHover(point){if(!this.context)return false;const context2D=this.context.context2D;const x=point.x/this.context.scale/window.devicePixelRatio;const y=point.y/this.context.scale/window.devicePixelRatio;let hover;context2D.save();context2D.setTransform(this.matrix.a,this.matrix.b,this.matrix.c,this.matrix.d,this.matrix.e+this.offset1.x+this.offset2.x,this.matrix.f+this.offset1.y+this.offset2.y);if(!this.context.features.nolinehover){context2D.lineWidth=this.linewidth;hover=context2D.isPointInPath(this.path,x,y)||context2D.isPointInStroke(this.path,x,y)}else hover=context2D.isPointInPath(this.path,x,y);context2D.restore();return hover}toFront(restrict=Restrict.none){const layer=Layer.decode(this.guid);const drawables=this.context.getDrawables(layer);const controls=this.context.getControls(layer);const group=this.context.get(this.group);let grouped=[];if(group)grouped=[...group.grouped,...group.enrolled].filter((drawable=>drawable.guid!=this.guid));[...grouped,...[this]].forEach((drawable=>{const drawableMap=drawables.map.get(drawable.guid);if(drawableMap){const drawableIndex=drawableMap.index;const controlIndex=controls.filter(((control,index)=>index==drawableIndex));const newIndex=drawables.index();drawables.index(drawable.guid,newIndex);if(controlIndex.length==1)this.context.link(drawable,controlIndex[0])}}));if(restrict==Restrict.none){drawables.sort();controls.reverse();this.context.states.sorted=true}}near(radius){return this.context.getDrawables().filter((drawable=>drawable.x>=this.x-radius&&drawable.y>=this.y-radius&&drawable.x<=this.x+radius&&drawable.y<=this.y+radius&&drawable.visible!=false))}static isCircleInsideCircle(small,big){const distance=Point.distance(big.point,small.point);return big.outerRadius>distance+small.outerRadius}onAttach(self){}onDetach(self){}onResize(self){}get context(){return this._context}set context(context){this._context=context}get fx(){return this._fx}set fx(fx){this._fx=fx}get guid(){return this._guid}set guid(guid){this._guid=guid}get group(){return this._group}set group(group){this._group=group}get point(){return new Point(this.x,this.y)}get points(){return this._points}set points(points){this._points=points}get offset1(){return this._offset1}set offset1(offset1){this._offset1=offset1}get offset2(){return this._offset2}set offset2(offset2){this._offset2=offset2}get width(){return this._size.width}set width(width){this._size.width=width}get height(){return this._size.height}set height(height){this._size.height=height}get size(){return new Size(this._size.width,this._size.height)}get boundaries(){return this._boundaries}set boundaries(boundaries){this._boundaries=boundaries}get path(){return this._path}set path(path){this._path=path}get shadow(){return this._shadow}set shadow(shadow){this._shadow=shadow}get shadowcolor(){return this._shadowcolor}set shadowcolor(shadowcolor){this._shadowcolor=shadowcolor}get fillcolor(){return this._fillcolor}set fillcolor(fillcolor){this._fillcolor=fillcolor}get strokecolor(){return this._strokecolor}set strokecolor(strokecolor){this._strokecolor=strokecolor}get linewidth(){return this._linewidth}set linewidth(linewidth){this._linewidth=linewidth}get alpha(){return this._alpha}set alpha(alpha){this._alpha=alpha}get visible(){return this._visible}set visible(visible){this._visible=visible}get nofill(){return this._nofill}set nofill(nofill){this._nofill=nofill}get nostroke(){return this._nostroke}set nostroke(nostroke){this._nostroke=nostroke}get hover(){return this._hover}set hover(hover){this._hover=hover}get sticky(){return this._sticky}set sticky(sticky){this._sticky=sticky}get removable(){return this._removable}set removable(removable){this._removable=removable}get hoverable(){return this._hoverable}set hoverable(hoverable){this._hoverable=hoverable}get attributes(){return{nofill:this.nofill,nostroke:this.nostroke,shadow:this.shadow,shadowcolor:this.shadowcolor,fillcolor:this.fillcolor,strokecolor:this.strokecolor,linewidth:this.linewidth,alpha:this.alpha,scale:this.scale,angle:this.angle,visible:this.visible,sticky:this.sticky,removable:this.removable,hoverable:this.hoverable,offset1:this.offset1,offset2:this.offset2,size:{width:this.width,height:this.height}}}}class Control{constructor(attributes={}){this._context=undefined;this._fx=undefined;this._drawable=undefined;this._guid=undefined;this._group=undefined;const{enabled=true,movable=true,removable=true,focusable=true,restrict=Restrict.none,context=null,layer=null,drawable=null,onLeftClick=null,onRightClick=null,onDragBegin=null,onDrag=null,onDragEnd=null,onInside=null,onOutside=null,onFocus=null,onLostFocus=null,onAttach=null,onDetach=null,onDrawable=null}=attributes;this._enabled=enabled;this._movable=movable;this._removable=removable;this._focusable=focusable;this._restrict=restrict;context?context.attach(this,layer):null;drawable?this.attach(drawable):null;onLeftClick?this.onLeftClick=onLeftClick:null;onRightClick?this.onRightClick=onRightClick:null;onDragBegin?this.onDragBegin=onDragBegin:null;onDrag?this.onDrag=onDrag:null;onDragEnd?this.onDragEnd=onDragEnd:null;onInside?this.onInside=onInside:null;onOutside?this.onOutside=onOutside:null;onFocus?this.onFocus=onFocus:null;onLostFocus?this.onLostFocus=onLostFocus:null;onAttach?this.onAttach=onAttach:null;onDetach?this.onDetach=onDetach:null;onDrawable?this.onDrawable=onDrawable:null}attach(drawable){if(!this.context||!drawable.context)throw new Error("Drawable and Control need to be both attached prior to use Control.attach()");this._drawable=this.context.get(drawable.guid);this.context.link(drawable,this);if(this._drawable)this.onDrawable(this)}onLeftClick(self){}onRightClick(self){}onDragBegin(self){}onDrag(self){}onDragEnd(self){}onInside(self){}onOutside(self){}onFocus(self){}onLostFocus(self){}onAttach(self){}onDetach(self){}onDrawable(self){}get context(){return this._context}set context(context){this._context=context}get group(){return this._group}set group(group){this._group=group}get fx(){return this._fx}set fx(fx){this._fx=fx}get guid(){return this._guid}set guid(guid){this._guid=guid}get drawable(){return this._drawable}get enabled(){return this._enabled}set enabled(enabled){this._enabled=enabled}get movable(){return this._movable}set movable(movable){this._movable=movable}get removable(){return this._removable}set removable(removable){this._removable=removable}get focusable(){return this._focusable}set focusable(focusable){this._focusable=focusable}get restrict(){return this._restrict}set restrict(restrict){this._restrict=restrict}}class Component{constructor(attributes={}){this._guid=undefined;this._context=undefined;this._fx=undefined;this._group=undefined;this._enrolled=new Foundation.ExtendedMap;const{sticky=false,point={x:window.innerWidth/2,y:window.innerHeight/2},size={width:50,height:50},context=null,layer=null,removable=true,onAttach=null,onDetach=null,onResize=null}=attributes;this._point=new Point(point.x,point.y);this._size=new Size(size.width,size.height);this._sticky=sticky;this._removable=removable;context?context.attach(this,layer):null;onAttach?this.onAttach=onAttach:null;onDetach?this.onDetach=onDetach:null;onResize?this.onResize=onResize:null}enroll(entity){if(entity instanceof Array){for(let item of entity){if(!this._enrolled.has(item.guid))this._enrolled.set(item.guid,item)}}else{if(!this._enrolled.has(entity.guid))this._enrolled.set(entity.guid,entity)}}setStickyDrawables(){this.getDrawables().forEach((drawable=>{drawable.sticky=this.sticky}))}getDrawables(){return this._enrolled.filter((entity=>entity instanceof Drawable))}getControls(){return this._enrolled.filter((entity=>entity instanceof Control))}getComponents(){return this._enrolled.filter((entity=>entity instanceof Component))}detachEnrolled(guid){if(guid){this.context.detach(guid);this._enrolled.delete(guid)}else{this.getComponents().forEach((component=>{this.context.detach(component.guid);this._enrolled.delete(component.guid)}));this.getDrawables().forEach((drawable=>{this.context.detach(drawable.guid);this._enrolled.delete(drawable.guid)}));this.getControls().forEach((control=>{this.context.detach(control.guid);this._enrolled.delete(control.guid)}))}}onAttach(self){}onDetach(self){}onResize(self){}get context(){return this._context}set context(context){this._context=context}get group(){return this._group}set group(group){this._group=group}get fx(){return this._fx}set fx(fx){this._fx=fx}get guid(){return this._guid}set guid(guid){this._guid=guid}get width(){return this._size.width}set width(width){this._size.width=width}get height(){return this._size.height}set height(height){this._size.height=height}get size(){return this._size}get x(){return this._point.x}set x(x){this._point.x=x}get y(){return this._point.y}set y(y){this._point.y=y}get point(){return this._point}get removable(){return this._removable}set removable(removable){this._removable=removable}get sticky(){return this._sticky}set sticky(sticky){this._sticky=sticky}set visible(visible){if(visible){this.getDrawables().forEach((drawable=>{drawable.visible=true}))}else{this.getDrawables().forEach((drawable=>{drawable.visible=false}))}}}class Group{constructor(attributes={}){this._context=undefined;this._guid=undefined;this._fx=undefined;this._grouped=new Foundation.ExtendedMap;this._enrolled=new Foundation.ExtendedMap;const{context=null,layer=null}=attributes;context?context.attach(this,layer):null}enroll(entity){if(entity instanceof Array){for(let item of entity){if(!this._enrolled.has(item.guid))this._enrolled.set(item.guid,item)}}else{console.log(entity.guid);if(!this._enrolled.has(entity.guid))this._enrolled.set(entity.guid,entity)}}attach(entity){if(entity instanceof Array){for(let item of entity){if(!this._grouped.has(item.guid)){let entry=this._grouped.set(item.guid,item);entry.group=this.guid}}}else{if(!this._grouped.has(entity.guid)){let entry=this._grouped.set(entity.guid,entity);entry.group=this.guid}}}detach(entity){if(entity instanceof Array){for(let item of entity){this._grouped.delete(item.guid);item.group=undefined}}else{this._grouped.delete(entity.guid);entity.group=undefined}}getDrawables(){return this._grouped.filter((entity=>entity instanceof Drawable))}getControls(){return this._grouped.filter((entity=>entity instanceof Control))}getComponents(){return this._grouped.filter((entity=>entity instanceof Component))}onAttach(self){}onDetach(self){this._grouped.map.forEach((entry=>{entry.object.group=undefined}));this._grouped.clear()}get context(){return this._context}set context(context){this._context=context}get guid(){return this._guid}set guid(guid){this._guid=guid}get fx(){return this._fx}set fx(fx){this._fx=fx}get grouped(){return this._grouped}get enrolled(){return this._enrolled}}class MouseAction{constructor(attributes={}){this._context=undefined;this._guid=undefined;this._fx=undefined;const{context=null,layer=null,removable=true,onAttach=null,onDetach=null,onMouseMove=null,onMouseDown=null,onMouseUp=null}=attributes;this._removable=removable;context?context.attach(this,layer):null;onAttach?this.onAttach=onAttach:null;onDetach?this.onDetach=onDetach:null;onMouseMove?this.onMouseMove=onMouseMove:null;onMouseDown?this.onMouseDown=onMouseDown:null;onMouseUp?this.onMouseUp=onMouseUp:null}onAttach(self){}onDetach(self){}onMouseMove(self){}onMouseDown(self){}onMouseUp(self){}get context(){return this._context}set context(context){this._context=context}get fx(){return this._fx}set fx(fx){this._fx=fx}get guid(){return this._guid}set guid(guid){this._guid=guid}get removable(){return this._removable}set removable(removable){this._removable=removable}}class DrawAction{constructor(attributes={}){this._context=undefined;this._guid=undefined;this._fx=undefined;const{context=null,layer=null,removable=true,onAttach=null,onDetach=null,onDrawBefore=null,onDrawAfter=null}=attributes;this._removable=removable;context?context.attach(this,layer):null;onAttach?this.onAttach=onAttach:null;onDetach?this.onDetach=onDetach:null;onDrawBefore?this.onDrawBefore=onDrawBefore:null;onDrawAfter?this.onDrawAfter=onDrawAfter:null}onAttach(self){}onDetach(self){}onDrawBefore(context2D,self){}onDrawAfter(context2D,self){}get context(){return this._context}set context(context){this._context=context}get fx(){return this._fx}set fx(fx){this._fx=fx}get guid(){return this._guid}set guid(guid){this._guid=guid}get removable(){return this._removable}set removable(removable){this._removable=removable}}class DragAction{constructor(attributes={}){this._context=undefined;this._guid=undefined;this._fx=undefined;const{context=null,layer=null,removable=true,onAttach=null,onDetach=null,onDragBegin=null,onDrag=null,onDragEnd=null}=attributes;this._removable=removable;context?context.attach(this,layer):null;onAttach?this.onAttach=onAttach:null;onDetach?this.onDetach=onDetach:null;onDragBegin?this.onDragBegin=onDragBegin:null;onDrag?this.onDrag=onDrag:null;onDragEnd?this.onDragEnd=onDragEnd:null}onAttach(self){}onDetach(self){}get context(){return this._context}set context(context){this._context=context}get fx(){return this._fx}set fx(fx){this._fx=fx}get guid(){return this._guid}set guid(guid){this._guid=guid}get removable(){return this._removable}set removable(removable){this._removable=removable}}class Events{static handleMouseMove(context,event){event.preventDefault();const layers=context.getLayers();const pointer=new Point(event.clientX,event.clientY,{scale:window.devicePixelRatio*context.scale});let refresh=false;context.states.pointer.last=context.states.pointer.current;context.states.pointer.current=pointer.toRealPosition(event.currentTarget);layers.forEach((layer=>{layer.mouseactions.forEach((mouseaction=>{mouseaction.onMouseMove(mouseaction)}));if(!context.states.drag&&!context.features.nohover){const stickies=layer.controls.sorted.filter((control=>control.drawable&&control.drawable.sticky&&control.drawable.visible));const nostickies=layer.controls.sorted.filter((control=>control.drawable&&!control.drawable.sticky&&control.drawable.visible));[...stickies,...nostickies].every((control=>{if(control.drawable&&control.drawable.hoverable){if(control.drawable.isHover(context.states.pointer.current)){if(context.states.pointer.control==control.guid)return false;else{const unhover=context.get(context.states.pointer.control);if(unhover){unhover.drawable.hover=false;unhover.onOutside(unhover)}context.states.pointer.control=control.guid;control.drawable.hover=true;control.onInside(control)}refresh=true;return false}else{if(context.states.pointer.control==control.guid){refresh=true;context.states.pointer.control=undefined;control.drawable.hover=false;control.onOutside(control)}}}return true}))}}));if(refresh&&!context.fx.id&&!context.states.drag)context.refresh()}static handleMouseDown(context,event){event.preventDefault();context.canvas.dispatchEvent(new MouseEvent("mousemove",{view:event.view,bubbles:true,cancelable:true,clientX:event.clientX,clientY:event.clientY}));context.states.pointer.clicked=new Point(context.states.pointer.current.x,context.states.pointer.current.y,{scale:1});context.states.mousedown=true;context.getLayers().forEach((layer=>{layer.mouseactions.forEach((mouseaction=>{mouseaction.onMouseDown(mouseaction)}))}));const control=context.get(context.states.pointer.control);if(event.button==0&&control&&control.enabled){if(control.focusable)context.setFocus(control.guid);if(control.movable&&!context.states.drag){context.id.dragging=window.setTimeout((()=>{if(control.drawable.isHover(context.states.pointer.current)){const group=context.get(control.drawable.group);if(group){[...group.grouped,...group.enrolled].forEach((drawable=>{drawable.points["origin"]=new Point(control.drawable.x-drawable.x,control.drawable.y-drawable.y,{scale:1})}))}context.states.pointer.dragdiff=new Point(context.states.pointer.current.x/context.scale/window.devicePixelRatio-control.drawable.x,context.states.pointer.current.y/context.scale/window.devicePixelRatio-control.drawable.y,{scale:context.scale*window.devicePixelRatio});context.states.drag=true;control.drawable.toFront();context.getLayers().forEach((layer=>{layer.dragactions.forEach((dragaction=>{dragaction.onDragBegin(dragaction)}))}));control.onDragBegin(control);context.drag()}}),context.dragging.delay)}}}static handleMouseUp(context,event){event.preventDefault();window.clearTimeout(context.id.dragging);const control=context.get(context.states.pointer.control);context.getLayers().forEach((layer=>{layer.mouseactions.forEach((mouseaction=>{mouseaction.onMouseUp(mouseaction)}))}));if(control instanceof Control){if(!context.states.drag&&context.states.pointer.control&&context.states.mousedown){if(event.button==0&&control.enabled&&control.drawable.visible){control.onLeftClick(control)}else if(event.button==2&&control.enabled&&control.drawable.visible)control.onRightClick(control)}else if(context.states.drag){if(!context.features.nosnapping&&context.dragging.restrict==Restrict.onrelease){control.drawable.x=Math.round((context.states.pointer.current.x-context.states.pointer.dragdiff.x)/(context.dragging.grid.x||1))*(context.dragging.grid.x||1);control.drawable.y=Math.round((context.states.pointer.current.y-context.states.pointer.dragdiff.y)/(context.dragging.grid.y||1))*(context.dragging.grid.y||1);control.drawable.x/=window.devicePixelRatio*context.scale;control.drawable.y/=window.devicePixelRatio*context.scale}context.getLayers().forEach((layer=>{layer.dragactions.forEach((dragaction=>{dragaction.onDragEnd(dragaction)}))}));control.onDragEnd(control)}}window.cancelAnimationFrame(context.id.dragging);context.states.mousedown=false;context.states.drag=false;if(!context.fx.id)context.refresh()}static handleResize(context,event){if(context.autosize){window.clearTimeout(context.id.resizing);context.id.resizing=window.setTimeout((()=>{context.size=new Size(window.innerWidth,window.innerHeight);context.getLayers().forEach((layer=>{layer.drawables.forEach((drawable=>{drawable.onResize(drawable)}));layer.components.forEach((component=>{component.onResize(component)}))}))}),250)}}static handleVisibilityChange(context,event){if(document.visibilityState==="visible")context.refresh()}static handleRightMouseClick(context,event){event.preventDefault()}static handleDragStart(context,event){event.preventDefault()}static handleTouchMove(context,event){event.preventDefault();const touches=event.touches||[];const ratio=window.devicePixelRatio;const point=new Point(touches[0].pageX/ratio,touches[0].pageY/ratio);context.canvas.dispatchEvent(new MouseEvent("mousemove",{view:event.view,bubbles:true,cancelable:true,clientX:point.x,clientY:point.y}));if(touches.length===2);else{if(!context.states.pinch);}}static handleTouchStart(context,event){event.preventDefault();const touches=event.touches||[];context.states.pinch=false;if(touches.length===2){context.states.mousedown=false;context.states.pinch=true}else{if(!context.states.pinch){const ratio=window.devicePixelRatio;const point=new Point(touches[0].pageX/ratio,touches[0].pageY/ratio);context.canvas.dispatchEvent(new MouseEvent("mousedown",{view:event.view,bubbles:true,cancelable:true,clientX:point.x,clientY:point.y}))}}}static handleTouchEnd(context,event){const touches=event.touches||[];context.states.pinch=false;if(touches.length===1);else{if(context.states.pinch);context.canvas.dispatchEvent(new MouseEvent("mouseup",{view:event.view,bubbles:true,cancelable:true}))}}static handleWindowTouchMove(context,event){if(context.states.drag||context.states.pinch){event.preventDefault();return false}}}class Fx{constructor(){this._stack=[];this._id=undefined}add(fx){const{drawable,duration=1e3,loop=false,effect,nogroup=false,smuggler={ease:Fx.easeLinear,angle:0,distance:0,scale:{x:1,y:1},data:{}},complete=null,t0=(new Date).getTime(),tdelta=0,t1=true,t9=false,t=0}=fx;if(fx.drawable instanceof Array){for(let i=0;i<fx.drawable.length;i++){this._stack.push({drawable:fx.drawable[i],duration,loop,effect,smuggler:{ease:smuggler.ease,angle:smuggler.angle,distance:smuggler.distance,scale:smuggler.scale,data:smuggler.data},complete:i==0?complete:null,t0,tdelta,t1,t9,t})}}else{if(drawable.group&&!fx.nogroup){let drawables=drawable.context.getDrawables().filter((drawable_=>drawable_.visible&&drawable_.group==drawable.group));let first=[...drawables][0];drawables.forEach((drawable=>{this._stack.push({drawable,duration,loop,effect,smuggler:{ease:smuggler.ease,angle:smuggler.angle,distance:smuggler.distance,scale:smuggler.scale,data:smuggler.data},complete:drawable==first?complete:null,t0,tdelta,t1,t9,t})}))}else{this._stack.push({drawable,duration,loop,effect,smuggler,complete,t0,tdelta,t1,t9,t})}}if(!this._id)this._id=window.requestAnimationFrame((()=>this.loop()))}loop(){for(let i=0;i<this._stack.length;i++){if(this._stack[i].drawable.guid==undefined){this._stack.splice(i,1);if(this._stack.length===0){window.cancelAnimationFrame(this._id);this.context.draw();this._id=undefined;break}continue}this._stack[i].stack=i;this._stack[i].t=1/this._stack[i].duration*((new Date).getTime()-this._stack[i].t0);this._stack[i].tdelta=this._stack[i].t-this._stack[i].tdelta;if(this._stack[i].t>1){this._stack[i].t=1;this._stack[i].t9=true}if(typeof this._stack[i].effect==="function")this._stack[i].effect(this._stack[i]);if(this._stack[i].t===1){if(typeof this._stack[i].complete==="function")this._stack[i].complete(this._stack[i]);if(this._stack[i].loop){this._stack[i].t=0;this._stack[i].t0=(new Date).getTime();this._stack[i].tdelta=0}else this._stack.splice(i,1);if(this._stack.length===0){window.cancelAnimationFrame(this._id);this.context.draw();this._id=undefined}}}if(this._stack.length>0){this._id=window.requestAnimationFrame((timestamp=>{this.loop();if(this._stack.length>0&&!this._context.states.drag)this._context.draw(timestamp)}))}}get(guid){const filter=this._stack.filter((fx=>fx.drawable.guid==guid));return filter[0]}fadeIn(fx){fx.drawable.alpha=fx.smuggler.ease(fx.t);fx.drawable.draw(fx.drawable.context.context2D)}fadeOut(fx){fx.drawable.alpha=1-fx.smuggler.ease(fx.t);fx.drawable.draw(fx.drawable.context.context2D)}rotate(fx){let ease=fx.smuggler.ease(fx.t);if(fx.t1){fx.t1=false;fx.smuggler.data={delta:0,degree:0,angle:{last:0,current:0}}}fx.smuggler.data.angle.last=fx.smuggler.data.angle.current;fx.smuggler.data.angle.current=ease*fx.smuggler.angle;let rad=Math.PI/180*(fx.smuggler.data.angle.current-fx.smuggler.data.angle.last);let sin=Math.sin(rad);let cos=Math.cos(rad);fx.drawable.matrix.multiplySelf(DOMMatrix.fromMatrix({a:cos,b:sin,c:-sin,d:cos,e:0,f:0}))}translate(fx){let ease=fx.smuggler.ease(fx.t);let distance=ease*fx.smuggler.distance;if(fx.t1){let rad=Math.PI/180*fx.smuggler.angle;let sin=Math.sin(rad);let cos=Math.cos(rad);fx.t1=false;fx.smuggler.data={origin:{x:fx.drawable.x,y:fx.drawable.y},delta:0,distance:0,sin,cos}}fx.smuggler.data.delta=distance-fx.smuggler.data.distance;fx.smuggler.data.distance=distance;fx.drawable.matrix.preMultiplySelf(DOMMatrix.fromMatrix({a:1,b:0,c:0,d:1,e:fx.smuggler.data.cos*fx.smuggler.data.delta,f:fx.smuggler.data.sin*fx.smuggler.data.delta}));if(fx.t9){fx.drawable.x=fx.smuggler.data.origin.x+fx.smuggler.data.cos*fx.smuggler.distance;fx.drawable.y=fx.smuggler.data.origin.y+fx.smuggler.data.sin*fx.smuggler.distance}}scale(fx){let ease=fx.smuggler.ease(fx.t);if(fx.t1){fx.t1=false;fx.smuggler.data={delta:{current:{x:0,y:0},last:{x:0,y:0}}}}fx.smuggler.data.delta.last=fx.smuggler.data.delta.current;fx.smuggler.data.delta.current={x:ease*fx.smuggler.scale.x,y:ease*fx.smuggler.scale.y};let scale=fx.drawable.scale;let diff={x:fx.smuggler.data.delta.current.x-fx.smuggler.data.delta.last.x,y:fx.smuggler.data.delta.current.y-fx.smuggler.data.delta.last.y};let adjust={x:scale.x-1+diff.x,y:scale.y-1+diff.y};let rad=fx.drawable.rad;let sin=Math.sin(rad);let cos=Math.cos(rad);fx.drawable.matrix=new DOMMatrix([cos*(1+adjust.x)||0,sin*(1+adjust.x)||0,-sin*(1+adjust.y)||0,cos*(1+adjust.y)||0,fx.drawable.x,fx.drawable.y])}static easeLinear(t){return t}static easeInSine(t){return 1-Math.cos(t*Math.PI/2)}static easeOutSine(t){return Math.sin(t*Math.PI/2)}static easeInOutSine(t){return-(Math.cos(Math.PI*t)-1)/2}static easeInQuad(t){return t*t}static easeOutQuad(t){return 1-(1-t)*(1-t)}static easeInOutQuad(t){return t<.5?2*t*t:1-Math.pow(-2*t+2,2)/2}static easeInCubic(t){return t*t*t}static easeOutCubic(t){return 1-Math.pow(1-t,3)}static easeInOutCubic(t){return t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2}static easeInQuart(t){return t*t*t*t}static easeOutQuart(t){return 1-Math.pow(1-t,4)}static easeInOutQuart(t){return t<.5?8*t*t*t*t:1-Math.pow(-2*t+2,4)/2}static easeInQuint(t){return t*t*t*t*t}static easeOutQuint(t){return 1-Math.pow(1-t,5)}static easeInOutQuint(t){return t<.5?16*t*t*t*t*t:1-Math.pow(-2*t+2,5)/2}static easeInExpo(t){return t===0?0:Math.pow(2,10*t-10)}static easeOutExpo(t){return t===1?1:1-Math.pow(2,-10*t)}static easeInOutExpo(t){return t===0?0:t===1?1:t<.5?Math.pow(2,20*t-10)/2:(2-Math.pow(2,-20*t+10))/2}static easeInCirc(t){return 1-Math.sqrt(1-Math.pow(t,2))}static easeOutCirc(t){return Math.sqrt(1-Math.pow(t-1,2))}static easeInOutCirc(t){return t<.5?(1-Math.sqrt(1-Math.pow(2*t,2)))/2:(Math.sqrt(1-Math.pow(-2*t+2,2))+1)/2}static easeInBack(t){const c1=1.70158;const c3=c1+1;return c3*t*t*t-c1*t*t}static easeOutBack(t){const c1=1.70158;const c3=c1+1;return 1+c3*Math.pow(t-1,3)+c1*Math.pow(t-1,2)}static easeInOutBack(t){const c1=1.70158;const c2=c1*1.525;return t<.5?Math.pow(2*t,2)*((c2+1)*2*t-c2)/2:(Math.pow(2*t-2,2)*((c2+1)*(t*2-2)+c2)+2)/2}static easeInElastic(t){const c4=2*Math.PI/3;return t===0?0:t===1?1:-Math.pow(2,10*t-10)*Math.sin((t*10-10.75)*c4)}static easeOutElastic(t){const c4=2*Math.PI/3;return t===0?0:t===1?1:Math.pow(2,-10*t)*Math.sin((t*10-.75)*c4)+1}static easeInOutElastic(t){const c5=2*Math.PI/4.5;return t===0?0:t===1?1:t<.5?-(Math.pow(2,20*t-10)*Math.sin((20*t-11.125)*c5))/2:Math.pow(2,-20*t+10)*Math.sin((20*t-11.125)*c5)/2+1}static easeInBounce(t){return 1-Fx.easeOutBounce(1-t)}static easeOutBounce(t){const n1=7.5625;const d1=2.75;if(t<1/d1)return n1*t*t;else if(t<2/d1)return n1*(t-=1.5/d1)*t+.75;else if(t<2.5/d1)return n1*(t-=2.25/d1)*t+.9375;else return n1*(t-=2.625/d1)*t+.984375}static easeInOutBounce(t){return t<.5?(1-Fx.easeOutBounce(1-2*t))/2:(1+Fx.easeOutBounce(2*t-1))/2}get context(){return this._context}set context(context){this._context=context}get id(){return this._id}}class Context{constructor(attributes={}){this._fx=new Fx;this._guid=new Foundation.Guid;this._layers=[];const{scale=1,layer=0,size=new Size(window.innerWidth,window.innerHeight),autosize=false,features={},dragging={}}=attributes;this._attributes={scale,autosize,features:{...{nohover:false,nolinehover:true,nosnapping:true},...features},dragging:{...{delay:180,restrict:Restrict.none,grid:{...{x:1,y:1},...dragging.grid}},...dragging}};this._viewport={canvas:{buffer:new OffscreenCanvas(0,0),main:document.createElement("canvas")},context:{buffer:undefined,main:undefined},id:{resizing:undefined,dragging:undefined},points:[],layer,states:{mobile:Foundation.Mobile.isMobile(),mousedown:false,pinch:false,drag:false,focussed:undefined,sorted:true,norefresh:false,pointer:{current:new Point(-1,-1,{scale}),last:new Point(-1,-1,{scale}),clicked:new Point(-1,-1,{scale}),control:undefined,dragdiff:new Point(-1,-1,{scale})},touch:{},timestamp:{delta:0,elapsed:0}}};new Layer({context:this,index:layer});this._viewport.context.main=this._viewport.canvas.main.getContext("bitmaprenderer",{alpha:true});this._viewport.context.buffer=this._viewport.canvas.buffer.getContext("2d",{alpha:true});this.size=size;this._viewport.canvas.main.addEventListener("touchmove",Events.handleTouchMove.bind(null,this),{passive:false});this._viewport.canvas.main.addEventListener("touchstart",Events.handleTouchStart.bind(null,this),{passive:false});this._viewport.canvas.main.addEventListener("touchend",Events.handleTouchEnd.bind(null,this),false);window.addEventListener("touchmove",Events.handleWindowTouchMove.bind(null,this),{passive:false});this._viewport.canvas.main.addEventListener("mousemove",Events.handleMouseMove.bind(null,this),{passive:false});this._viewport.canvas.main.addEventListener("mousedown",Events.handleMouseDown.bind(null,this),false);this._viewport.canvas.main.addEventListener("mouseup",Events.handleMouseUp.bind(null,this),false);this._viewport.canvas.main.addEventListener("resize",Events.handleResize.bind(null,this),false);this._viewport.canvas.main.addEventListener("contextmenu",Events.handleRightMouseClick.bind(null,this),false);this._viewport.canvas.main.addEventListener("dragstart",Events.handleDragStart.bind(null,this),false);this._viewport.canvas.main.addEventListener("dragover",Events.handleMouseMove.bind(null,this),{passive:false});window.addEventListener("resize",Events.handleResize.bind(null,this),false);window.addEventListener("visibilitychange",Events.handleVisibilityChange.bind(null,this),false);this._fx.context=this}link(drawable,control){const layerDrawable=Layer.decode(drawable.guid);const layerControl=Layer.decode(control.guid);if(layerDrawable!=layerControl)throw new Error("Context.link() - both drawable and control need to be in the same layer");const d=this._layers[layerDrawable].drawables.map.get(drawable.guid);const c=this._layers[layerDrawable].controls.map.get(control.guid);c.index=d.index;this.states.sorted=false}enroll(entity){entity.context=this;return entity}attach(entity,layerOverride){let guid;let entry;let layer;if(layerOverride!=undefined||layerOverride!=null){if(!this._layers[layerOverride]){new Layer({context:this,index:layerOverride});console.log("Layer "+layerOverride+" was created as it was missing")}layer=layerOverride}else layer=this._viewport.layer;const layerString=Layer.encode(layer);if(entity instanceof Drawable){guid=this.getGuidGenerator().create("00000000-"+layerString+"-0000-draw-000000xxxxxx");entry=this._layers[layer].drawables.set(guid,entity);this.states.sorted=false}else if(entity instanceof Control){guid=this.getGuidGenerator().create("00000000-"+layerString+"-0000-ctrl-000000xxxxxx");entry=this._layers[layer].controls.set(guid,entity);this.states.sorted=false}else if(entity instanceof Component){guid=this.getGuidGenerator().create("00000000-"+layerString+"-0000-comp-000000xxxxxx");entry=this._layers[layer].components.set(guid,entity);this.states.sorted=false}else if(entity instanceof Group){guid=this.getGuidGenerator().create("00000000-"+layerString+"-0000-grup-000000xxxxxx");entry=this._layers[layer].groups.set(guid,entity)}else if(entity instanceof DrawAction){guid=this.getGuidGenerator().create("00000000-"+layerString+"-0000-dact-000000xxxxxx");entry=this._layers[layer].drawactions.set(guid,entity)}else if(entity instanceof MouseAction){guid=this.getGuidGenerator().create("00000000-"+layerString+"-0000-mact-000000xxxxxx");entry=this._layers[layer].mouseactions.set(guid,entity)}else if(entity instanceof DragAction){guid=this.getGuidGenerator().create("00000000-"+layerString+"-0000-drag-000000xxxxxx");entry=this._layers[layer].dragactions.set(guid,entity)}else if(entity instanceof Layer){guid=this.getGuidGenerator().create("00000000-"+String(entity.index).padStart(4,"0")+"-0000-layr-000000xxxxxx");this._layers[entity.index]=entity;entry=this._layers[entity.index]}else if(entity instanceof HTMLElement){entity.appendChild(this._viewport.canvas.main);return null}else throw new Error("Context.attach() wrong type");entry.context=this;entry.guid=guid;entry.fx=this._fx;entry.onAttach(entry);return entry}detach(guids,restrict=Restrict.norefresh){let guidlist;if(guids instanceof Array)guidlist=guids;else guidlist=new Array(guids);for(let guid of guidlist){if(typeof guid!="string")continue;const layer=Layer.decode(guid);const type=guid.substring(19,23);if(type=="draw"){const entity=this._layers[layer].drawables.get(guid);if(entity&&entity.removable){const group=this.get(entity.group);if(group)group.detach(entity);entity.onDetach(entity);entity.context=undefined;entity.guid=undefined;entity.fx=undefined;this._layers[layer].drawables.delete(guid)}}else if(type=="ctrl"){const entity=this._layers[layer].controls.get(guid);if(entity&&entity.removable){entity.onDetach(entity);entity.context=undefined;entity.guid=undefined;entity.fx=undefined;this._layers[layer].controls.delete(guid)}}else if(type=="grup"){const entity=this._layers[layer].groups.get(guid);if(entity){entity.onDetach(entity);entity.context=undefined;entity.guid=undefined;this._layers[layer].groups.delete(guid)}}else if(type=="comp"){const entity=this._layers[layer].components.get(guid);if(entity&&entity.removable){entity.onDetach(entity);entity.context=undefined;entity.guid=undefined;entity.fx=undefined;this._layers[layer].components.delete(guid)}}else if(type=="dact"){const entity=this._layers[layer].drawactions.get(guid);if(entity&&entity.removable){entity.onDetach(entity);entity.context=undefined;entity.guid=undefined;entity.fx=undefined;this._layers[layer].drawactions.delete(guid)}}else if(type=="mact"){const entity=this._layers[layer].mouseactions.get(guid);if(entity&&entity.removable){entity.onDetach(entity);entity.context=undefined;entity.guid=undefined;entity.fx=undefined;this._layers[layer].mouseactions.delete(guid)}}else if(type=="drag"){const entity=this._layers[layer].dragactions.get(guid);if(entity&&entity.removable){entity.onDetach(entity);entity.context=undefined;entity.guid=undefined;entity.fx=undefined;this._layers[layer].dragactions.delete(guid)}}else if(type=="layr"){const entity=this._layers[layer];if(entity){entity.onDetach(entity);entity.context=undefined;entity.guid=undefined;this._layers[layer]=undefined}}}this.states.sorted=false;if(restrict==Restrict.none&&!this.fx.id&&!this.states.drag)this.refresh()}get(guid){if(guid){const layer=Layer.decode(guid);const type=guid.substring(19,23);if(type=="draw")return this._layers[layer].drawables.get(guid);else if(type=="ctrl")return this._layers[layer].controls.get(guid);else if(type=="grup")return this._layers[layer].groups.get(guid);else if(type=="comp")return this._layers[layer].components.get(guid);else if(type=="dact")return this._layers[layer].drawactions.get(guid);else if(type=="mact")return this._layers[layer].mouseactions.get(guid);else if(type=="drag")return this._layers[layer].dragactions.get(guid);else if(type=="layr")return this._layers[layer]}}refresh(){if(!this._viewport.states.norefresh)window.requestAnimationFrame((timestamp=>this.draw(timestamp)))}loop(callback){const _this=this;function infinite(timestamp){if(callback)callback();if(!_this._viewport.states.norefresh)_this.draw(timestamp);window.requestAnimationFrame((timestamp=>infinite(timestamp)))}window.requestAnimationFrame((timestamp=>infinite(timestamp)))}drag(){if(this.states.drag){const control=this.get(this.states.pointer.control);if(control.restrict==Restrict.none){control.drawable.x=this.states.pointer.current.x-this.states.pointer.dragdiff.x;control.drawable.y=this.states.pointer.current.y-this.states.pointer.dragdiff.y;control.drawable.x/=window.devicePixelRatio*this.scale;control.drawable.y/=window.devicePixelRatio*this.scale}else if(control.restrict==Restrict.horizontal){control.drawable.x=this.states.pointer.current.x-this.states.pointer.dragdiff.x;control.drawable.x/=window.devicePixelRatio*this.scale}else if(control.restrict==Restrict.vertical){control.drawable.y=this.states.pointer.current.y-this.states.pointer.dragdiff.y;control.drawable.y/=window.devicePixelRatio*this.scale}if(!this.features.nosnapping&&this.dragging.restrict==Restrict.ondrag){control.drawable.x=Math.round((this.states.pointer.current.x-this.states.pointer.dragdiff.x)/(this.dragging.grid.x||1))*(this.dragging.grid.x||1);control.drawable.y=Math.round((this.states.pointer.current.y-this.states.pointer.dragdiff.y)/(this.dragging.grid.y||1))*(this.dragging.grid.y||1);control.drawable.x/=window.devicePixelRatio*this.scale;control.drawable.y/=window.devicePixelRatio*this.scale}if(control.drawable.group){const group=this.get(control.drawable.group);[...group.grouped,...group.enrolled].forEach((drawable=>{drawable.x=control.drawable.x-drawable.points["origin"].x;drawable.y=control.drawable.y-drawable.points["origin"].y}))}}this._viewport.id.dragging=window.requestAnimationFrame((timestamp=>{this.draw(timestamp);this.drag()}))}draw(timestamp){const layers=this.getLayers();const control=this.get(this.states.pointer.control);this.states.timestamp.delta=timestamp-this.states.timestamp.elapsed;this.states.timestamp.elapsed=timestamp;if(!this.states.sorted){layers.forEach((layer=>{layer.drawables.sort();layer.controls.reverse()}));this.states.sorted=true}this.onDrawBefore(this.context2D);layers.forEach((layer=>{if(layer.visible){let context2D=this.context2D;if(layer.freezed&&!layer.bitmap){context2D=layer.context2D}if(!layer.bitmap){layer.drawactions.forEach((drawaction=>{drawaction.onDrawBefore(context2D,drawaction)}));const stickies=layer.drawables.sorted.filter((drawable=>drawable.sticky&&drawable.visible));const nostickies=layer.drawables.sorted.filter((drawable=>!drawable.sticky&&drawable.visible));if(this.states.drag){for(let drawable of[...nostickies,...stickies]){if(drawable.guid==control.drawable.guid){context2D.save();this.getLayers().forEach((layer=>{layer.dragactions.forEach((dragaction=>{dragaction.onDrag(dragaction)}))}));control.onDrag(control);drawable.draw(context2D);context2D.restore()}else drawable.draw(context2D)}}else{for(let drawable of[...nostickies,...stickies])drawable.draw(context2D)}layer.drawactions.forEach((drawaction=>{drawaction.onDrawAfter(context2D,drawaction)}));if(layer.freezed){layer.save();context2D.drawImage(layer.bitmap,0,0)}}else{context2D.drawImage(layer.bitmap,0,0)}}}));this.onDrawAfter(this.context2D);const bitmap=this._viewport.canvas.buffer.transferToImageBitmap();this._viewport.context.main.transferFromImageBitmap(bitmap)}setFocus(guid){const focusControl=this.get(guid);if(focusControl instanceof Control&&guid!=this.states.focussed){if(this.states.focussed!=undefined){const unfocusControl=this.get(this.states.focussed);if(unfocusControl instanceof Control)unfocusControl.onLostFocus(unfocusControl)}focusControl.onFocus(focusControl);this.states.focussed=guid}}removeFocus(){if(this.states.focussed!=undefined){const unfocusControl=this.get(this.states.focussed);if(unfocusControl instanceof Control)unfocusControl.onLostFocus(unfocusControl);this.states.focussed=undefined}}getGuidGenerator(){return this._guid}getDrawables(layer){return layer>=0?this._layers[layer].drawables:this._layers[this._viewport.layer].drawables}getAllDrawables(){let all=new Foundation.ExtendedMap;this.getLayers().forEach((layer=>{layer.drawables.forEach((drawable=>{all.set(drawable.guid,drawable)}))}));return all}getControls(layer){return layer>=0?this._layers[layer].controls:this._layers[this._viewport.layer].controls}getAllControls(){let all=new Foundation.ExtendedMap;this.getLayers().forEach((layer=>{layer.controls.forEach((control=>{all.set(control.guid,control)}))}));return all}getComponents(layer){return layer>=0?this._layers[layer].components:this._layers[this._viewport.layer].components}getAllComponents(){let all=new Foundation.ExtendedMap;this.getLayers().forEach((layer=>{layer.components.forEach((component=>{all.set(component.guid,component)}))}));return all}getGroups(layer){return layer>=0?this._layers[layer].groups:this._layers[this._viewport.layer].groups}getAllGroups(){let all=new Foundation.ExtendedMap;this.getLayers().forEach((layer=>{layer.groups.forEach((group=>{all.set(group.guid,group)}))}));return all}getDrawActions(layer){return layer>=0?this._layers[layer].drawactions:this._layers[this._viewport.layer].drawactions}getAllDrawActions(){let all=new Foundation.ExtendedMap;this.getLayers().forEach((layer=>{layer.drawactions.forEach((drawaction=>{all.set(drawaction.guid,drawaction)}))}));return all}getMouseActions(layer){return layer>=0?this._layers[layer].mouseactions:this._layers[this._viewport.layer].mouseactions}getAllMouseActions(){let all=new Foundation.ExtendedMap;this.getLayers().forEach((layer=>{layer.mouseactions.forEach((mouseaction=>{all.set(mouseaction.guid,mouseaction)}))}));return all}getDragActions(layer){return layer>=0?this._layers[layer].dragactions:this._layers[this._viewport.layer].dragactions}getAllDragActions(){let all=new Foundation.ExtendedMap;this.getLayers().forEach((layer=>{layer.dragactions.forEach((dragaction=>{all.set(dragaction.guid,dragaction)}))}));return all}getLayers(){return this._layers.filter((l=>l!=undefined&&l!=null))}getLayer(layer){return this._layers.filter((l=>l!=undefined&&l!=null&&(layer>=0?Layer.decode(l.guid)==layer:true)))[0]}onDrawBefore(context2D){}onDrawAfter(context2D){}get canvas(){return this._viewport.canvas.main}get context2D(){return this._viewport.context.buffer}get fx(){return this._fx}get width(){return this.canvas.width}get height(){return this.canvas.height}get size(){return new Size(this.canvas.width,this.canvas.height)}set size(size){let ratio=1;this._viewport.canvas.main.width=size.width*ratio;this._viewport.canvas.main.height=size.height*ratio;this._viewport.canvas.buffer.width=size.width*ratio;this._viewport.canvas.buffer.height=size.height*ratio;this.refresh()}get scale(){return this._attributes.scale}set scale(scale){this._attributes.scale=scale}get features(){return this._attributes.features}set features(features){this._attributes.features=features}get dragging(){return this._attributes.dragging}set dragging(dragging){this._attributes.dragging=dragging}get autosize(){return this._attributes.autosize}set autosize(autosize){this._attributes.autosize=autosize}get layer(){return this._viewport.layer}set layer(layer){this._viewport.layer=layer;if(!this._layers[layer]){new Layer({context:this,index:layer});console.log("layer "+layer+" was created as it was missing")}}get states(){return this._viewport.states}get id(){return this._viewport.id}get points(){return this._viewport.points}}var Style;(function(Style){Style["normal"]="normal";Style["italic"]="italic";Style["oblique"]="oblique"})(Style||(Style={}));var Variant;(function(Variant){Variant["normal"]="normal";Variant["caps"]="small-caps"})(Variant||(Variant={}));var Weight;(function(Weight){Weight["normal"]="normal";Weight["bold"]="bold";Weight["bolder"]="bolder";Weight["lighter"]="lighter"})(Weight||(Weight={}));var Font=Object.freeze({__proto__:null,get Style(){return Style},get Variant(){return Variant},get Weight(){return Weight}});var Direction;(function(Direction){Direction[Direction["right"]=0]="right";Direction[Direction["down"]=90]="down";Direction[Direction["left"]=180]="left";Direction[Direction["top"]=270]="top";Direction[Direction["horizontal"]=180]="horizontal";Direction[Direction["vertical"]=0]="vertical"})(Direction||(Direction={}));var Align;(function(Align){Align[Align["center"]=0]="center";Align[Align["top"]=1]="top";Align[Align["bottom"]=2]="bottom";Align[Align["left"]=3]="left";Align[Align["right"]=4]="right"})(Align||(Align={}));var Enums=Object.freeze({__proto__:null,get Align(){return Align},get Direction(){return Direction},Font,get Restrict(){return Restrict}});class Polygon extends Drawable{constructor(attributes={}){super(attributes);const{generate=true,sides=8,angleStart=0,angleEnd=360,outerRadius=25,innerRadius=0}=attributes;this._outerRadius=outerRadius;this._innerRadius=innerRadius;this._angleStart=angleStart;this._angleEnd=angleEnd;this._sides=sides;this.width=outerRadius*2;this.height=outerRadius*2;if(generate)this.generate()}generate(){const points=[];let x;let y;for(let i=0;i<this._sides+1;i++){const angle=Math.PI/180*this._angleStart+i*(Math.PI/180*(this._angleEnd-this._angleStart))/this._sides;x=this._outerRadius*Math.cos(angle);y=this._outerRadius*Math.sin(angle);points.push(new Point(x,y))}if(this._innerRadius>0){for(let i=this._sides;i>=0;i--){const angle=Math.PI/180*this._angleStart+i*(Math.PI/180*(this._angleEnd-this._angleStart))/this._sides;x=this._innerRadius*Math.cos(angle);y=this._innerRadius*Math.sin(angle);points.push(new Point(x,y))}}this.path=new Path2D;this.path.moveTo(points[0].x,points[0].y);for(let i=1;i<points.length;i++)this.path.lineTo(points[i].x,points[i].y);this.path.lineTo(points[0].x,points[0].y);this.path.closePath();this.points=points;this.width=this._outerRadius*2;this.height=this._outerRadius*2;this.boundaries={topleft:new Point(this.x-this._outerRadius-(this.nostroke?0:this.linewidth/2),this.y-this._outerRadius-(this.nostroke?0:this.linewidth/2)),bottomright:new Point(this.x+this._outerRadius+(this.nostroke?0:this.linewidth/2),this.y+this._outerRadius+(this.nostroke?0:this.linewidth/2))}}clone(attributes={}){const cloned=new Polygon({...this.attributes,...{outerRadius:this._outerRadius,innerRadius:this._innerRadius,angleStart:this._angleStart,angleEnd:this._angleEnd,sides:this._sides},...attributes});return cloned}get outerRadius(){return this._outerRadius}set outerRadius(outerRadius){this._outerRadius=outerRadius}get innerRadius(){return this._innerRadius}set innerRadius(innerRadius){this._innerRadius=innerRadius}get angleStart(){return this._angleStart}set angleStart(angleStart){this._angleStart=angleStart}get angleEnd(){return this._angleEnd}set angleEnd(angleEnd){this._angleEnd=angleEnd}get sides(){return this._sides}set sides(sides){this._sides=sides}}class Circle extends Drawable{constructor(attributes={}){super(attributes);const{generate=true,angleStart=0,angleEnd=360,outerRadius=25,innerRadius=0}=attributes;this._outerRadius=outerRadius;this._innerRadius=innerRadius;this._angleStart=angleStart;this._angleEnd=angleEnd;this.width=outerRadius*2;this.height=outerRadius*2;if(generate)this.generate()}generate(){const points=[new Point(0,0),new Point(0,0)];points[0].translate(this._angleEnd,this._outerRadius);points[1].translate(this._angleStart,this._innerRadius);this.path=new Path2D;if(this._angleStart!=0||this._angleEnd!=360||this._innerRadius!=0){this.path.arc(0,0,this._innerRadius,this._angleStart/180*Math.PI,this._angleEnd/180*Math.PI,false);this.path.lineTo(points[0].x,points[0].y)}this.path.arc(0,0,this._outerRadius,this._angleEnd/180*Math.PI,this._angleStart/180*Math.PI,true);if(this._angleStart!=0||this._angleEnd!=360||this._innerRadius!=0)this.path.lineTo(points[1].x,points[1].y);this.path.closePath();this.points=points;this.width=this._outerRadius*2;this.height=this._outerRadius*2;this.boundaries={topleft:new Point(this.x-this._outerRadius-(this.nostroke?0:this.linewidth/2),this.y-this._outerRadius-(this.nostroke?0:this.linewidth/2)),bottomright:new Point(this.x+this._outerRadius+(this.nostroke?0:this.linewidth/2),this.y+this._outerRadius+(this.nostroke?0:this.linewidth/2))}}clone(attributes={}){const cloned=new Circle({...this.attributes,...{outerRadius:this._outerRadius,innerRadius:this._innerRadius,angleStart:this._angleStart,angleEnd:this.angleEnd},...attributes});return cloned}get outerRadius(){return this._outerRadius}set outerRadius(outerRadius){this._outerRadius=outerRadius}get innerRadius(){return this._innerRadius}set innerRadius(innerRadius){this._innerRadius=innerRadius}get angleStart(){return this._angleStart}set angleStart(angleStart){this._angleStart=angleStart}get angleEnd(){return this._angleEnd}set angleEnd(angleEnd){this._angleEnd=angleEnd}}class Hexagon extends Polygon{constructor(attributes={}){super({...attributes,...{sides:6}})}clone(attributes={}){const cloned=new Hexagon({...this.attributes,...{outerRadius:this.outerRadius,innerRadius:this.innerRadius,angleStart:this.angleStart,angleEnd:this.angleEnd,sides:this.sides},...attributes});return cloned}}class Rectangle extends Drawable{constructor(attributes={}){super(attributes);const{generate=true,rounded={}}=attributes;this._rounded={...{topLeft:0,topRight:0,bottomLeft:0,bottomRight:0},...rounded};if(generate)this.generate()}generate(){const point=new Point(-this.width/2,-this.height/2);const points=[new Point(point.x,point.y),new Point(point.x+this.width,point.y),new Point(point.x+this.width,point.y+this.height),new Point(point.x,point.y+this.height)];this.path=new Path2D;this.path.moveTo(points[0].x+this._rounded.topLeft,points[0].y);this.path.lineTo(points[1].x-this._rounded.topRight,points[1].y);this.path.quadraticCurveTo(points[1].x,points[1].y,points[1].x,points[1].y+this._rounded.topRight);this.path.lineTo(points[2].x,points[2].y-this._rounded.bottomRight);this.path.quadraticCurveTo(points[2].x,points[2].y,points[2].x-this._rounded.bottomRight,points[2].y);this.path.lineTo(points[3].x+this._rounded.bottomLeft,points[3].y);this.path.quadraticCurveTo(points[3].x,points[3].y,points[3].x,points[3].y-this._rounded.bottomLeft);this.path.lineTo(points[0].x,points[0].y+this._rounded.topLeft);this.path.quadraticCurveTo(points[0].x,points[0].y,points[0].x+this._rounded.topLeft,points[0].y);this.path.closePath();this.points=points;this.boundaries={topleft:new Point(this.x-this.width/2-(this.nostroke?0:this.linewidth/2),this.y-this.height/2-(this.nostroke?0:this.linewidth/2)),bottomright:new Point(this.x+this.width/2+(this.nostroke?0:this.linewidth/2),this.y+this.height/2+(this.nostroke?0:this.linewidth/2))}}clone(attributes={}){const cloned=new Rectangle({...this.attributes,...{rounded:this._rounded},...attributes});return cloned}get rounded(){return this._rounded}set rounded(rounded){this._rounded=rounded}}class Cross extends Drawable{constructor(attributes={}){super({...{linewidth:10},...attributes,...{nofill:true}});const{generate=true}=attributes;if(generate)this.generate()}generate(){const points=[new Point(0,-this.height/2),new Point(0,this.height/2),new Point(-this.width/2,0),new Point(this.width/2,0)];this.path=new Path2D;this.path.moveTo(points[0].x,points[0].y);this.path.lineTo(points[1].x,points[1].y);this.path.moveTo(points[2].x,points[2].y);this.path.lineTo(points[3].x,points[3].y);this.path.closePath();this.points=points;this.boundaries={topleft:new Point(this.x-this.width/2-(this.nostroke?0:this.linewidth/2),this.y-this.height/2-(this.nostroke?0:this.linewidth/2)),bottomright:new Point(this.x+this.width/2+(this.nostroke?0:this.linewidth/2),this.y+this.height/2+(this.nostroke?0:this.linewidth/2))}}clone(attributes={}){const cloned=new Cross({...this.attributes,...attributes});return cloned}}class Line extends Drawable{constructor(attributes={}){super({...{linewidth:10},...attributes,...{nofill:true}});const{generate=true,point0={x:window.innerWidth/2-25,y:window.innerHeight/2},point1={x:window.innerWidth/2+25,y:window.innerHeight/2}}=attributes;if(Point.distance(new Point(0,0),new Point(point0.x,point0.y))<Point.distance(new Point(0,0),new Point(point1.x,point1.y))){this._point0=new Point(point0.x,point0.y);this._point1=new Point(point1.x,point1.y)}else{this._point0=new Point(point1.x,point1.y);this._point1=new Point(point0.x,point0.y)}let point=Point.middle(this._point0,this._point1);this.x=point.x;this.y=point.y;if(generate)this.generate()}generate(){const point=new Point(this.x,this.y);const distance1=Point.distance(point,this._point0);const distance2=Point.distance(point,this._point1);const angle1=Point.angle(point,this._point0);const angle2=Point.angle(point,this._point1);const points=[new Point(0,0),new Point(0,0)];points[0].translate(angle1,distance1);points[1].translate(angle2,distance2);this.path=new Path2D;this.path.moveTo(points[0].x,points[0].y);this.path.lineTo(points[1].x,points[1].y);this.path.closePath();this.points=points;this.width=Math.abs(points[1].x-points[0].x);this.height=Math.abs(points[1].y-points[0].y);this.boundaries={topleft:new Point(this.x-this.width/2,this.y-this.height/2),bottomright:new Point(this.x+this.width/2,this.y+this.height/2)}}clone(attributes={}){const distance1=Point.distance(this.point,this._point0);const distance2=Point.distance(this.point,this._point1);const angle1=Point.angle(this.point,this._point0);const angle2=Point.angle(this.point,this._point1);const points=[new Point(window.innerWidth/2,window.innerHeight/2),new Point(window.innerWidth/2,window.innerHeight/2)];points[0].translate(angle1,distance1);points[1].translate(angle2,distance2);const cloned=new Line({...this.attributes,...{point0:points[0],point1:points[1]},...attributes});return cloned}get point0(){return this._point0}set point0(point0){this._point0=point0}get point1(){return this._point1}set point1(point1){this._point1=point1}}class Label extends Drawable{constructor(attributes={}){super({...attributes});this._canvas=new OffscreenCanvas(0,0);this._splitted=[];const{nostroke=true,content="",font="16px system-ui",padding={},spacing=3,wrapping=false,corner=false,autosize=false,multiline=false,infinite=false,tabsize=3,fillbackground="",generate=true,filter=null}=attributes;this.nostroke=nostroke;this._content=content;this._font=font;this._padding={...{top:0,bottom:0,left:0,right:0},...padding};this._spacing=spacing;this._corner=corner;this._wrapping=wrapping;this._autosize=autosize;this._multiline=multiline;this._tabsize=tabsize;this._fillbackground=fillbackground;this._filter=filter;this._infinite=infinite;if(generate)this.generate()}generate(){const context2D=this._canvas.getContext("2d");let x=0;let y=2;let maxwidth=0;let boundingbox=this.boundingbox("[j");if(this._multiline){if(this._wrapping){if(this._autosize){this._maxline=window.innerHeight/(boundingbox.height+this._spacing)+1;this._splitted=this.wrap(this.width-(this._padding.left+this._padding.right),this._maxline);this.height=(boundingbox.height+this._spacing)*this._splitted.length}else{this._maxline=Math.floor((this.height-(this._padding.left+this._padding.right))/(boundingbox.height+this._spacing));this._splitted=this.wrap(this.width-(this._padding.left+this._padding.right),this._maxline)}}else{this._splitted=this._content.replace(/\t/g," ".repeat(this._tabsize)).split("\n");if(this._autosize){boundingbox=this.boundingbox(this._content.replace(/\t/g," ".repeat(this._tabsize)));this.width=boundingbox.width;this.height=(boundingbox.height+this._spacing)*this._splitted.length}}}else{this._maxline=1;if(this._wrapping)this._splitted=this.wrap(this.width-(this._padding.left+this._padding.right),1);else this._splitted[0]=this._content.replace(/\t/g," ".repeat(this._tabsize));if(this._autosize){boundingbox=this.boundingbox(this._content.replace(/\t/g," ".repeat(this._tabsize)));this.width=boundingbox.width;this.height=boundingbox.height+this._spacing+1}}this._canvas.width=this.width-(this._padding.left+this._padding.right)+1;this._canvas.height=this.height-(this._padding.top+this._padding.bottom);this.path=new Path2D;if(this._corner){this.path.rect(0,0,this.width,this.height);this.boundaries={topleft:new Point(this.x,this.y),bottomright:new Point(this.x+this.width+maxwidth,this.y+this.height+y-this._spacing)}}else{this.path.rect(-this.width/2,-this.height/2,this.width,this.height);this.boundaries={topleft:new Point(this.x-this.width/2,this.y-this.height/2),bottomright:new Point(this.x+this.width/2+maxwidth,this.y+this.height/2+y-this._spacing)}}this.path.closePath();this.points=[this.boundaries.topleft,new Point(this.boundaries.bottomright.x,this.boundaries.topleft.y),this.boundaries.bottomright,new Point(this.boundaries.topleft.x,this.boundaries.bottomright.y)];context2D.fillStyle=this.fillcolor;context2D.font=this._font;context2D.textAlign="left";context2D.textBaseline="top";context2D.shadowBlur=this.shadow;context2D.shadowColor=this.shadowcolor;context2D.imageSmoothingEnabled=false;const maxline=this._multiline?Math.floor((this.height-(this._padding.top+this._padding.bottom))/(boundingbox.height+this._spacing)):1;const length=this._splitted.length;let mark=false;let markcolor;for(let row=0;row<length;row++){if(row<=maxline){if(this._filter&&this._filter[row]){const keys=Object.keys(this._filter[row]);if(Object.entries(this._filter[row]).length>0){const string=this._splitted[row].substring(0,parseInt(keys[0]));if(mark){const backup=context2D.fillStyle;context2D.fillStyle=markcolor;context2D.fillRect(x,y,context2D.measureText(string).width,boundingbox.height);context2D.fillStyle=backup}context2D.fillText(string,x,y);x+=context2D.measureText(string).width;Object.entries(this._filter[row]).forEach((([column,columnvalue])=>{const nextColumn=keys.indexOf(column)+1;const nextIndex=parseInt(keys[nextColumn])||this._splitted[row].length;const string=this._splitted[row].substring(parseInt(column),nextIndex);if(columnvalue.mark===true)mark=true;else if(columnvalue.mark===false)mark=false;if(columnvalue.markcolor)markcolor=columnvalue.markcolor;if(mark){const backup=context2D.fillStyle;context2D.fillStyle=markcolor;context2D.fillRect(x,y,context2D.measureText(string).width,boundingbox.height);context2D.fillStyle=backup}if(columnvalue.font)context2D.font=columnvalue.font;if(columnvalue.fillcolor)context2D.fillStyle=columnvalue.fillcolor;if(columnvalue.spacing)this._spacing=columnvalue.spacing;if(columnvalue.yoffset)y+=columnvalue.yoffset;if(columnvalue.xoffset)x+=columnvalue.xoffset;context2D.fillText(string,x,y);x+=context2D.measureText(string).width}))}else{if(mark){const backup=context2D.fillStyle;context2D.fillStyle=markcolor;context2D.fillRect(x,y,context2D.measureText(this._splitted[row]).width,boundingbox.height);context2D.fillStyle=backup}context2D.fillText(this._splitted[row],x,y)}}else{const measure=context2D.measureText(this._splitted[row]).width;if(measure>maxwidth){maxwidth=measure;if(maxwidth>this.width)maxwidth=this.width}if(mark){const backup=context2D.fillStyle;context2D.fillStyle=markcolor;context2D.fillRect(x,y,context2D.measureText(this._splitted[row]).width,boundingbox.height);context2D.fillStyle=backup}context2D.fillText(this._splitted[row],x,y)}if(x>maxwidth){maxwidth=x;if(maxwidth>this.width)maxwidth=this.width}x=0;y+=boundingbox.height+this._spacing}else break}}draw(context2D){context2D.save();context2D.setTransform(this.matrix.a,this.matrix.b,this.matrix.c,this.matrix.d,this.matrix.e+this.offset1.x+this.offset2.x,this.matrix.f+this.offset1.y+this.offset2.y);context2D.globalAlpha=this.alpha;context2D.imageSmoothingEnabled=false;context2D.strokeStyle=this.strokecolor;if(!this.nostroke)context2D.stroke(this.path);if(this._fillbackground!=""){context2D.fillStyle=this._fillbackground;context2D.fill(this.path)}context2D.shadowBlur=this.shadow;context2D.shadowColor=this.shadowcolor;if(this._canvas.width>0&&this._canvas.height>0){if(this._corner)context2D.drawImage(this._canvas,this._padding.left,this._padding.top);else context2D.drawImage(this._canvas,-this._canvas.width/2+this._padding.left,-this._canvas.height/2+this._padding.top)}context2D.restore()}wrap(maxwidth,maxline){const context2D=this._canvas.getContext("2d");let row=0;let aOut=[];let nCount=0;let lines=this._content.split("\n");context2D.save();context2D.font=this._font;for(let line of lines){let nLineWidth=0;let aWords=line.split(/(?=[ \t])|(?<=[ \t])/g);aOut[row]="";for(let word of aWords){let nWordWidth=context2D.measureText(word).width;if(word=="\t"){word=" ".repeat(this._tabsize);nWordWidth=context2D.measureText(word).width}if(nWordWidth>=maxwidth){aOut[row]+=word;maxwidth-=context2D.measureText("...").width;if(maxwidth<0)maxwidth=0;while(context2D.measureText(aOut[row]).width>maxwidth)aOut[row]=aOut[row].slice(0,-1);aOut[row]+="...";context2D.restore();return aOut}else if(nWordWidth+nLineWidth<maxwidth){aOut[row]+=word;nLineWidth+=nWordWidth}else{if(++row<maxline){if(word!=" "){aOut[row]=word;nLineWidth=nWordWidth}else{aOut[row]="";nLineWidth=0}}else{if(this._infinite){this._content=this._content.replace(aOut[0],"").replace(/^\s+/gm,"");if(this._content[0]=="\n")this._content=this._content.replace("^\n","");aOut.shift();row--;if(word!=" "){aOut[row]=word;nLineWidth=nWordWidth}else{aOut[row]="";nLineWidth=0}for(let i=0;i<row;i++)this._filter[i]=this._filter[i+1]}else{aOut[row-1]+=word;maxwidth-=context2D.measureText("...").width;if(maxwidth<0)maxwidth=0;while(context2D.measureText(aOut[row-1]).width>maxwidth)aOut[row-1]=aOut[row-1].slice(0,-1);aOut[row-1]+="...";context2D.restore();return aOut}}}}nCount++;row++;if(row>=maxline){if(this._infinite){if(lines.length>nCount){this._content=this._content.replace(aOut[0],"").replace(/^\s+/gm,"");if(this._content[0]=="\n")this._content=this._content.replace("^\n","");aOut.shift();row--;for(let i=0;i<row;i++)this._filter[i]=this._filter[i+1]}}else{if(lines.length>nCount){maxwidth-=context2D.measureText("...").width;if(maxwidth<0)maxwidth=0;while(context2D.measureText(aOut[maxline-1]).width>maxwidth)aOut[maxline-1]=aOut[maxline-1].slice(0,-1);aOut[maxline-1]+="..."}break}}}context2D.restore();return aOut}boundingbox(text){const context2D=this._canvas.getContext("2d");let boundingbox={width:0,height:0};context2D.save();context2D.font=this._font;context2D.textAlign="left";context2D.textBaseline="top";if(text)boundingbox.width=context2D.measureText(text).width;else boundingbox.width=0;boundingbox.height=context2D.measureText("[j").actualBoundingBoxDescent+context2D.measureText("[j").actualBoundingBoxAscent;context2D.restore();return boundingbox}change(properties){let style=this._font.match(/italic|oblique/g);let variant=this._font.match(/small-caps/g);let weight=this._font.match(/bold|bolder|lighter/g);this._font=this._font.replace(/normal|italic|oblique|small-caps|bold|bolder|lighter/g,"");if(!style)style=Array("");if(!variant)variant=Array("");if(!weight)weight=Array("");if(properties.style)style[0]=properties.style;if(properties.variant)variant[0]=properties.variant;if(properties.weight)weight[0]=properties.weight;this._font=(style[0].length>0?style[0]+" ":"")+(variant[0].length>0?variant[0]+" ":"")+(weight[0].length>0?weight[0]:"")+this._font;if(properties.size)this._font=this._font.replace(/(\d+)px/g,properties.size+"px");if(properties.family){const index=this._font.lastIndexOf(" ");this._font=this._font.substring(0,index)+" "+properties.family}this.generate()}clone(attributes={}){const cloned=new Label({...this.attributes,...{autosize:this._autosize,content:this._content,corner:this._corner,fillbackground:this._fillbackground,filter:this._filter,font:this._font,multiline:this._multiline,padding:this._padding,spacing:this._spacing,tabsize:this._tabsize,wrapping:this._wrapping},...attributes});return cloned}get canvas(){return this._canvas}get content(){return this._content}set content(content){this._content=content}get contentAs(){if(!this._splitted[0])this._splitted[0]="";return{splitted:this._splitted}}get font(){return this._font}set font(font){this._font=font}get padding(){return this._padding}set padding(padding){this._padding={...this._padding,...{padding}}}get spacing(){return this._spacing}set spacing(spacing){this._spacing=spacing}get wrapping(){return this._wrapping}set wrapping(wrapping){this._wrapping=wrapping}get corner(){return this._corner}set corner(corner){this._corner=corner}get autosize(){return this._autosize}set autosize(autosize){this._autosize=autosize}get multiline(){return this._multiline}set multiline(multiline){this._multiline=multiline}get tabsize(){return this._tabsize}set tabsize(tabsize){this._tabsize=tabsize}get fillbackground(){return this._fillbackground}set fillbackground(fillbackground){this._fillbackground=fillbackground}get filter(){return this._filter}set filter(filter){this._filter=filter}get maxline(){return this._maxline}}class Artwork extends Rectangle{constructor(attributes={}){super({...attributes,...{generate:false}});this._image=new Image;this._loaded=false;const{content="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",autoload=true,padding=0,autosize=true,nofill=true,nostroke=true}=attributes;this._padding=padding;this._autosize=autosize;this._autoload=autoload;this.nofill=nofill;this.nostroke=nostroke;if(content instanceof HTMLImageElement)this._image=content;else if(typeof content==="string")this._image.src=content;this._image.onload=()=>{if(this._autosize){this.width=this._image.width;this.height=this._image.height}if(this._autoload){this._loaded=true;this.generate();this.context.refresh()}}}generate(){const point=new Point(-this.width/2,-this.height/2);const points=[new Point(point.x,point.y),new Point(point.x+this.width,point.y),new Point(point.x+this.width,point.y+this.height),new Point(point.x,point.y+this.height)];this.path=new Path2D;this.path.rect(points[0].x,points[0].y,this.width,this.height);this.path.closePath();this.points=points;this.boundaries={topleft:new Point(this.x-this.width/2-(this.nostroke?0:this.linewidth/2),this.y-this.height/2-(this.nostroke?0:this.linewidth/2)),bottomright:new Point(this.x+this.width/2+(this.nostroke?0:this.linewidth/2),this.y+this.height/2+(this.nostroke?0:this.linewidth/2))}}draw(context2D){if(this._loaded){context2D.save();context2D.setTransform(this.matrix.a,this.matrix.b,this.matrix.c,this.matrix.d,this.matrix.e+this.offset1.x+this.offset2.x,this.matrix.f+this.offset1.y+this.offset2.y);context2D.lineWidth=this.linewidth;context2D.strokeStyle=this.strokecolor;context2D.fillStyle=this.fillcolor;context2D.globalAlpha=this.alpha;context2D.shadowBlur=this.shadow;context2D.shadowColor=this.shadowcolor;context2D.imageSmoothingEnabled=false;if(!this.nostroke)context2D.stroke(this.path);if(!this.nofill)context2D.fill(this.path);context2D.drawImage(this._image,0,0,this._image.width,this._image.height,-this.width/2+this._padding,-this.height/2+this._padding,this._image.width,this._image.height);context2D.restore()}}clone(attributes={}){const cloned=new Artwork({...this.attributes,...{content:this._image,padding:this._padding,autosize:this._autosize,autoload:this._autoload},...attributes});return cloned}set base64(base64){this._image.src=base64}get base64(){return this._image.src}set image(image){this._image=image}get image(){return this._image}get padding(){return this._padding}set padding(padding){this._padding=padding}get autosize(){return this._autosize}set autosize(autosize){this._autosize=autosize}get autoload(){return this._autoload}set autoload(autoload){this._autoload=autoload}}class Star extends Drawable{constructor(attributes={}){super(attributes);const{generate=true,outerRadius=25,innerRadius=10,spikes=6}=attributes;this._spikes=spikes;this._innerRadius=innerRadius;this._outerRadius=outerRadius;this.width=outerRadius*2;this.height=outerRadius*2;if(generate)this.generate()}generate(){const points=[];const step=Math.PI/this._spikes;let angle=Math.PI/2*3;for(let i=0;i<this._spikes;i++){points.push(new Point(this._outerRadius*Math.cos(angle),this._outerRadius*Math.sin(angle)));angle+=step;points.push(new Point(this._innerRadius*Math.cos(angle),this._innerRadius*Math.sin(angle)));angle+=step}this.path=new Path2D;for(let i=0;i<points.length;i++)this.path.lineTo(points[i].x,points[i].y);this.path.lineTo(points[0].x,points[0].y);this.path.closePath();this.points=points;this.width=this._outerRadius*2;this.height=this._outerRadius*2;this.boundaries={topleft:new Point(this.x-this._outerRadius-(this.nostroke?0:this.linewidth/2),this.y-this._outerRadius-(this.nostroke?0:this.linewidth/2)),bottomright:new Point(this.x+this._outerRadius+(this.nostroke?0:this.linewidth/2),this.y+this._outerRadius+(this.nostroke?0:this.linewidth/2))}}clone(attributes={}){const cloned=new Star({...this.attributes,...{outerRadius:this._outerRadius,innerRadius:this._innerRadius,spikes:this._spikes},...attributes});return cloned}get outerRadius(){return this._outerRadius}set outerRadius(outerRadius){this._outerRadius=outerRadius}get innerRadius(){return this._innerRadius}set innerRadius(innerRadius){this._innerRadius=innerRadius}get spikes(){return this._spikes}set spikes(spikes){this._spikes=spikes}}class Triangle extends Polygon{constructor(attributes={}){super({...{angle:30},...attributes,...{sides:3}})}clone(attributes={}){const cloned=new Triangle({...this.attributes,...{outerRadius:this.outerRadius,innerRadius:this.innerRadius,angleStart:this.angleStart,angleEnd:this.angleEnd,sides:this.sides},...attributes});return cloned}}class Smiley extends Drawable{constructor(attributes={}){super({...attributes,...{nostroke:true}});const{generate=true,outerRadius=25,fillmouth="#000000",filleyes="#000000"}=attributes;this.width=outerRadius*2;this.height=outerRadius*2;this._outerRadius=outerRadius;this._mouth=new Path2D;this._eyes=new Path2D;this._fillmouth=fillmouth;this._filleyes=filleyes;if(generate)this.generate()}generate(){this.path=new Path2D;this._mouth=new Path2D;this._eyes=new Path2D;this.path.arc(0,0,this._outerRadius,0,Math.PI*4,false);this._mouth.arc(0,this._outerRadius/10,this._outerRadius/1.5,0,Math.PI,false);this._eyes.moveTo(-20,-5);this._eyes.arc(-(this._outerRadius/3),-(this._outerRadius/2.5),this._outerRadius/5,0,Math.PI*4,false);this._eyes.moveTo(this._outerRadius/3,-(this._outerRadius/2.5));this._eyes.arc(this._outerRadius/3,-(this._outerRadius/2.5),this._outerRadius/5,0,Math.PI*4,false);this.path.closePath();this._mouth.closePath();this._eyes.closePath();this.width=this._outerRadius*2;this.height=this._outerRadius*2;this.boundaries={topleft:new Point(this.x-this._outerRadius,this.y-this._outerRadius),bottomright:new Point(this.x+this._outerRadius,this.y+this._outerRadius)}}draw(context2D){context2D.save();context2D.setTransform(this.matrix.a,this.matrix.b,this.matrix.c,this.matrix.d,this.matrix.e+this.offset1.x+this.offset2.x,this.matrix.f+this.offset1.y+this.offset2.y);context2D.lineWidth=this.linewidth;context2D.globalAlpha=this.alpha;context2D.shadowBlur=this.shadow;context2D.shadowColor=this.shadowcolor;if(!this.nofill){context2D.fillStyle=this.fillcolor;context2D.fill(this.path);context2D.fillStyle=this._fillmouth;context2D.fill(this._mouth);context2D.fillStyle=this._filleyes;context2D.fill(this._eyes)}context2D.restore()}clone(attributes={}){const cloned=new Smiley({...this.attributes,...{radius:this._outerRadius,fillmouth:this._fillmouth,filleyes:this._filleyes},...attributes});return cloned}get outerRadius(){return this._outerRadius}set outerRadius(outerRadius){this._outerRadius=outerRadius}get fillmouth(){return this._fillmouth}set fillmouth(fillmouth){this._fillmouth=fillmouth}get filleyes(){return this._filleyes}set filleyes(filleyes){this._filleyes=filleyes}}class Arrow extends Drawable{constructor(attributes={}){super(attributes);const{generate=true,baseHeight=25,baseWidth=15}=attributes;this._baseHeight=baseHeight;this._baseWidth=baseWidth;if(generate)this.generate()}generate(){const diff=(this.height-this._baseHeight)/2;const point=new Point(-this.width/2,-this.height/2);const points=[new Point(point.x+this._baseWidth,point.y+diff),new Point(point.x,point.y+diff),new Point(point.x,point.y+this.height-diff),new Point(point.x+this._baseWidth,point.y+this.height-diff),new Point(point.x+this._baseWidth,point.y+this.height),new Point(point.x+this.width,point.y+this.height/2),new Point(point.x+this._baseWidth,point.y)];this.path=new Path2D;this.path.moveTo(points[0].x,points[0].y);this.path.lineTo(points[1].x,points[1].y);for(let i=1;i<points.length;i++)this.path.lineTo(points[i].x,points[i].y);this.path.lineTo(points[0].x,points[0].y);this.path.closePath();this.points=points;this.boundaries={topleft:new Point(this.x-this.width/2-(this.nostroke?0:this.linewidth/2),this.y-this.height/2-(this.nostroke?0:this.linewidth/2)),bottomright:new Point(this.x+this.width/2+(this.nostroke?0:this.linewidth/2),this.y+this.height/2+(this.nostroke?0:this.linewidth/2))}}clone(attributes={}){const cloned=new Arrow({...this.attributes,...{baseHeight:this._baseHeight,baseWidth:this._baseWidth},...attributes});return cloned}get baseWidth(){return this._baseWidth}set baseWidth(baseWidth){this._baseWidth=baseWidth}get baseHeight(){return this._baseHeight}set baseHeight(baseHeight){this._baseHeight=baseHeight}}class Blade extends Star{constructor(attributes={}){super({...attributes,...{generate:false}});const{generate=true,twist=4}=attributes;this._twist=twist;if(generate)this.generate()}generate(){const points=[];for(let i=0;i<this.spikes;i++){const angle=i*(this._twist*Math.PI)/this.spikes;points.push(new Point(this.outerRadius*Math.cos(angle),this.outerRadius*Math.sin(angle)));points.push(new Point(this.innerRadius*Math.cos(angle),this.innerRadius*Math.sin(angle)))}this.path=new Path2D;for(let i=0;i<points.length;i++)this.path.lineTo(points[i].x,points[i].y);this.path.lineTo(points[0].x,points[0].y);this.path.closePath();this.points=points;this.width=this.outerRadius*2;this.height=this.outerRadius*2;this.boundaries={topleft:new Point(this.x-this.outerRadius-(this.nostroke?0:this.linewidth/2),this.y-this.outerRadius-(this.nostroke?0:this.linewidth/2)),bottomright:new Point(this.x+this.outerRadius+(this.nostroke?0:this.linewidth/2),this.y+this.outerRadius+(this.nostroke?0:this.linewidth/2))}}clone(attributes={}){const cloned=new Blade({...this.attributes,...{outerRadius:this.outerRadius,innerRadius:this.innerRadius,spikes:this.spikes,twist:this._twist},...attributes});return cloned}get twist(){return this._twist}set twist(twist){this._twist=twist}}class Points extends Drawable{constructor(attributes={}){const context=attributes.context;super({...attributes,...{context:null,layer:null,generate:false}});this.generate();context?context.attach(this,attributes.layer):null}generate(){this.path=new Path2D;this.path.moveTo(this.points[0].x,this.points[0].y);for(let i=1;i<this.points.length;i++)this.path.lineTo(this.points[i].x,this.points[i].y);this.path.lineTo(this.points[0].x,this.points[0].y);this.path.closePath()}clone(attributes={}){const cloned=new Points({...this.attributes,...attributes});return cloned}}var Drawables=Object.freeze({__proto__:null,Arrow,Artwork,Blade,Circle,Cross,Hexagon,Label,Line,Points,Polygon,Rectangle,Smiley,Star,Triangle});class Matter{constructor(attributes={}){this._entities=[];const{context=null,engine={},render={},runner={},mouseConstraint={},norender=false}=attributes;this._context=context;this._attributes={engine,render,runner,mouseConstraint,norender};this.initMatter();this.initPaperless()}initMatter(){this._engine=MatterJS.Engine.create({...{enableSleeping:true,positionIterations:6,velocityIterations:4,constraintIterations:2},...this._attributes.engine});this._mouse=MatterJS.Mouse.create(this._attributes.norender?this._context.canvas:document.body);this._render=MatterJS.Render.create({...{element:document.body,engine:this._engine,mouse:this._mouse,options:{width:window.innerWidth,height:window.innerHeight,background:"transparent",wireframes:false}},...this._attributes.render});this._runner=MatterJS.Runner.create({...{delta:1e3/(60*10),maxFrameTime:1e3/50},...this._attributes.runner});this._mouseConstraint=MatterJS.Common.extend({...{type:"mouseConstraint",mouse:this._mouse,element:null,body:null,constraint:MatterJS.Constraint.create({label:"Mouse Constraint",pointA:this._mouse.position,pointB:{x:0,y:0},length:.01,stiffness:0,angularStiffness:0,render:{visible:false}}),collisionFilter:{category:1,mask:4294967295,group:0}},...this._attributes.mouseConstraint});if(!this._attributes.norender){MatterJS.Events.on(this._engine,"beforeUpdate",(()=>{const allBodies=MatterJS.Composite.allBodies(this._engine.world);MatterJS.MouseConstraint.update(this._mouseConstraint,allBodies);MatterJS.MouseConstraint._triggerEvents(this._mouseConstraint)}))}if(this._attributes.norender){this._mouseConstraint.mouse.element.removeEventListener("wheel",this._mouseConstraint.mouse.mousewheel);this._mouseConstraint.mouse.element.removeEventListener("DOMMouseScroll",this._mouseConstraint.mouse.mousewheel);this._mouseConstraint.mouse.element.removeEventListener("startdrag",this._mouseConstraint.mouse.startdrag);this._mouseConstraint.mouse.element.removeEventListener("enddrag",this._mouseConstraint.mouse.enddrag);this._mouseConstraint.mouse.element.removeEventListener("mousedown",this._mouseConstraint.mouse.mousedown);this._mouseConstraint.mouse.element.removeEventListener("mouseup",this._mouseConstraint.mouse.mouseup);this._mouseConstraint.mouse.element.removeEventListener("mousemove",this._mouseConstraint.mouse.mousemove);this._mouseConstraint.mouse.element.removeEventListener("touchmove",this._mouseConstraint.mouse.mousemove);this._mouseConstraint.mouse.element.removeEventListener("touchstart",this._mouseConstraint.mouse.mousedown);this._mouseConstraint.mouse.element.removeEventListener("touchend",this._mouseConstraint.mouse.mouseup)}this._mouseConstraint.mouse.element.addEventListener("mousemove",(event=>{const control=this._context.get(this._context.states.pointer.control);if(this._context.states.drag){if(control.restrict==Restrict.none){this._mouse.position.x=this._context.states.pointer.current.x;this._mouse.position.y=this._context.states.pointer.current.y}else if(control.restrict==Restrict.horizontal){this._mouse.position.x=this._context.states.pointer.current.x}else if(control.restrict==Restrict.vertical){this._mouse.position.y=this._context.states.pointer.current.y}}else{this._mouse.position.x=this._context.states.pointer.current.x;this._mouse.position.y=this._context.states.pointer.current.y}}));MatterJS.World.add(this._engine.world,this._mouseConstraint);MatterJS.Common.setDecomp(decomp);MatterJS.Runner.run(this._runner,this._engine);if(!this._attributes.norender)MatterJS.Render.run(this._render)}initPaperless(){let position;new DrawAction({context:this._context,onDrawBefore:()=>{const awake=this._entities.filter((entity=>!entity.body.isSleeping));const limit=25;awake.forEach((entity=>{entity.drawable.x=entity.body.position.x;entity.drawable.y=entity.body.position.y;entity.drawable.rad=entity.body.angle;if(entity.body.velocity.x>limit||entity.body.velocity.y>limit){MatterJS.Body.setVelocity(entity.body,{x:Math.min(limit,Math.max(-limit,entity.body.velocity.x)),y:Math.min(limit,Math.max(-limit,entity.body.velocity.y))})}}))}});new DragAction({context:this._context,onDragBegin:()=>{const control=this._context.get(this._context.states.pointer.control);const bodies=MatterJS.Composite.allBodies(this._engine.world);const mouse=this._mouseConstraint.mouse;const constraint=this._mouseConstraint.constraint;let body=this._mouseConstraint.body;position=control.drawable.point;if(!constraint.bodyB){for(let i=0;i<bodies.length;i++){body=bodies[i];if(MatterJS.Bounds.contains(body.bounds,mouse.position)&&MatterJS.Detector.canCollide(body.collisionFilter,this._mouseConstraint.collisionFilter)){for(let j=body.parts.length>1?1:0;j<body.parts.length;j++){const part=body.parts[j];if(MatterJS.Vertices.contains(part.vertices,mouse.position)){constraint.pointA=mouse.position;constraint.bodyB=this._mouseConstraint.body=body;constraint.pointB={x:mouse.position.x-body.position.x,y:mouse.position.y-body.position.y};constraint.angleB=body.angle;constraint.bodyB.inertiaOld=constraint.bodyB.inertia;MatterJS.Body.setInertia(constraint.bodyB,Infinity);MatterJS.Sleeping.set(body,false);break}}}}}else{MatterJS.Sleeping.set(constraint.bodyB,false);constraint.pointA=mouse.position}},onDrag:()=>{if(this._mouseConstraint.constraint.bodyB){let adjust={x:0,y:0};if(this._mouseConstraint.constraint.bodyB.bounds.min.x<=0)adjust.x=-(this._mouseConstraint.constraint.bodyB.bounds.min.x-1);else if(this._mouseConstraint.constraint.bodyB.bounds.max.x>=this._context.width)adjust.x=-(this._mouseConstraint.constraint.bodyB.bounds.max.x-this._context.width+1);if(this._mouseConstraint.constraint.bodyB.bounds.min.y<=0)adjust.y=-(this._mouseConstraint.constraint.bodyB.bounds.min.y-1);else if(this._mouseConstraint.constraint.bodyB.bounds.max.y>=this._context.height)adjust.y=-(this._mouseConstraint.constraint.bodyB.bounds.max.y-this._context.height+1);if(adjust.x!=0||adjust.y!=0)MatterJS.Body.setPosition(this._mouseConstraint.constraint.bodyB,{x:this._mouseConstraint.constraint.bodyB.position.x+adjust.x,y:this._mouseConstraint.constraint.bodyB.position.y+adjust.y})}},onDragEnd:()=>{if(this._mouseConstraint.constraint.bodyB)MatterJS.Body.setInertia(this._mouseConstraint.constraint.bodyB,this._mouseConstraint.constraint.bodyB.inertiaOld);else{const control=this._context.get(this._context.states.pointer.control);control.drawable.x=position.x;control.drawable.y=position.y;console.log("Matter body not in sync with the Drawable")}this._mouseConstraint.constraint.bodyB=this._mouseConstraint.body=null;this._mouseConstraint.constraint.pointB=null}})}Rectangle(body,drawable={}){const b=MatterJS.Bodies.rectangle(body.point.x,body.point.y,body.size.width,body.size.height,{...body.options,...{render:{visible:this._attributes.norender?false:true}}});const d=new Rectangle({...drawable,...{context:this._context,point:{x:body.point.x,y:body.point.y},size:{width:body.size.width,height:body.size.height}}});MatterJS.World.add(this._engine.world,b);this._entities.push({drawable:d,body:b});return{drawable:d,body:b}}Smiley(body,drawable={}){const b=MatterJS.Bodies.circle(body.point.x,body.point.y,body.radius,{...body.options,...{render:{visible:this._attributes.norender?false:true}}},body.sides);const d=new Smiley({...drawable,...{context:this._context,point:{x:body.point.x,y:body.point.y},outerRadius:body.radius}});MatterJS.World.add(this._engine.world,b);this._entities.push({drawable:d,body:b});return{drawable:d,body:b}}Hexagon(body,drawable={}){const polygon=this.Polygon({...body,...{sides:6}},drawable);return polygon}Arrow(body,drawable={}){const d=new Arrow({...drawable,...{context:this._context,point:{x:body.point.x,y:body.point.y},size:{width:body.size.width,height:body.size.height},baseWidth:body.baseWidth,baseHeight:body.baseHeight}});const b=MatterJS.Bodies.fromVertices(body.point.x,body.point.y,d.points);const center=MatterJS.Vertices.centre(d.points);MatterJS.Body.setCentre(b,{x:body.point.x-center.x,y:body.point.y-center.y});MatterJS.Body.setPosition(b,{x:body.point.x,y:body.point.y});MatterJS.World.add(this._engine.world,b);this._entities.push({drawable:d,body:b});return{drawable:d,body:b}}Circle(body,drawable={}){body.outerRadius||25;const sides=body.sides||25;const polygon=this.Polygon({...body,...{sides}},drawable);return polygon}Polygon(body,drawable={}){const outerRadius=body.outerRadius||25;const innerRadius=body.innerRadius||0;const angleStart=body.angleStart||0;const angleEnd=body.angleEnd||360;let sides=body.sides||8;let vertices=[];let x;let y;for(let i=0;i<sides+1;i++){const angle=Math.PI/180*angleStart+i*(Math.PI/180*(angleEnd-angleStart))/sides;x=outerRadius*Math.cos(angle);y=outerRadius*Math.sin(angle);vertices.push({x,y})}if(innerRadius>0){for(let i=sides;i>=0;i--){const angle=Math.PI/180*angleStart+i*(Math.PI/180*(angleEnd-angleStart))/sides;x=innerRadius*Math.cos(angle);y=innerRadius*Math.sin(angle);vertices.push({x,y})}}const b=MatterJS.Bodies.fromVertices(body.point.x,body.point.y,vertices,{...body.options,...{render:{visible:this._attributes.norender?false:true}}},undefined,undefined,undefined,innerRadius>0?false:undefined);if(innerRadius>0){const center=MatterJS.Vertices.centre(vertices);MatterJS.Body.setCentre(b,{x:body.point.x-center.x,y:body.point.y-center.y})}const d=new Polygon({...drawable,...{context:this._context,point:{x:body.point.x,y:body.point.y},outerRadius,innerRadius,angleStart,angleEnd,sides}});MatterJS.Body.setPosition(b,{x:body.point.x,y:body.point.y});MatterJS.World.add(this._engine.world,b);this._entities.push({drawable:d,body:b});return{drawable:d,body:b}}Points(body,drawable={}){const points=body.points||[];const b=MatterJS.Bodies.fromVertices(body.point.x,body.point.y,points,{...body.options,...{render:{visible:this._attributes.norender?false:true}}},undefined,undefined,undefined,false);let d;d=new(drawable.path?Drawable:Points)({...drawable,...{context:this._context,point:{x:body.point.x,y:body.point.y},points}});const center=MatterJS.Vertices.centre(points);MatterJS.Body.setCentre(b,{x:body.point.x-center.x,y:body.point.y-center.y});MatterJS.Body.setPosition(b,{x:body.point.x,y:body.point.y});MatterJS.World.add(this._engine.world,b);this._entities.push({drawable:d,body:b});return{drawable:d,body:b}}get MatterJS(){return MatterJS}get context(){return this._context}get engine(){return this._engine}get runner(){return this._runner}get mouse(){return this._mouse}get mouseConstraint(){return this._mouseConstraint}}class Intersects{static isCircleIntersectCircle(circle1,circle2){return IntersectsJS.circleCircle(circle1.x,circle1.y,circle1.outerRadius,circle2.x,circle2.y,circle2.outerRadius)}}var Interfaces=Object.freeze({__proto__:null});class Blank extends Control{constructor(attributes={}){super(attributes)}}class Button extends Control{constructor(attributes={}){super({...attributes,...{context:null,layer:null,drawable:null}});const{callbackLeftClick=()=>{},callbackRightClick=()=>{},smugglerLeftClick=null,smugglerRightClick=null}=attributes;this._callbackLeftClick=callbackLeftClick;this._callbackRightClick=callbackRightClick;this._smugglerLeftClick=smugglerLeftClick;this._smugglerRightClick=smugglerRightClick;attributes.context?attributes.context.attach(this,attributes.layer):null;attributes.drawable?this.attach(attributes.drawable):null}onLeftClick(self){if(this.drawable.hover&&typeof this._callbackLeftClick==="function"){this._callbackLeftClick(this._smugglerLeftClick);return true}return false}onRightClick(self){if(this.drawable.hover&&typeof this._callbackRightClick==="function"){this._callbackRightClick(this._smugglerRightClick);return true}return false}leftClick(){this._callbackLeftClick(this._smugglerLeftClick)}rightClick(){this._callbackRightClick(this._smugglerRightClick)}get callbackLeftClick(){return this._callbackLeftClick}set callbackLeftClick(callbackLeftClick){this._callbackLeftClick=callbackLeftClick}get callbackRightClick(){return this._callbackRightClick}set callbackRightClick(callbackRightClick){this._callbackRightClick=callbackRightClick}get smugglerLeftClick(){return this._smugglerLeftClick}set smugglerLeftClick(smugglerLeftClick){this._smugglerLeftClick=smugglerLeftClick}get smugglerRightClick(){return this._smugglerRightClick}set smugglerRightClick(smugglerRightClick){this._smugglerRightClick=smugglerRightClick}}var Controls=Object.freeze({__proto__:null,Blank,Button});export{Component,Context,Control,Controls,DragAction,DrawAction,Drawable,Drawables,Enums,Fx,Group,Interfaces,Intersects,Layer,Matrix,Matter,MouseAction,Point,Size};